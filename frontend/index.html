<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flashcard App</title>
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/components.css">
    <style>
        /* Reserved for debugging and testing */
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="action-controls">Flashcard App
        <!-- Removed 'Toggle Library' and 'Toggle Completed' buttons -->
      </div>
    </div>
    <div class="app-layout">
      <!-- Left Column -->
      <div id="sect-nav" class="section-base sidebar-nav is-visible">
        <div class="section-header sidebar-header">
          <button id="btn-nav-hamburger" class="sidebar-icon-btn" title="Collapse/Expand Navigation" aria-label="Collapse/Expand Navigation">
            <!-- Hamburger SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect y="4" width="24" height="2" rx="1" fill="#555"/><rect y="11" width="24" height="2" rx="1" fill="#555"/><rect y="18" width="24" height="2" rx="1" fill="#555"/></svg>
          </button>
        </div>
        <div class="section-content sidebar-content">
            <button id="btn-nav-home" class="sidebar-btn is-active" type="button">
                <!-- Home SVG -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 9l2 1.5V20h16V10.5L22 9l-10-7zM12 4.5L19 10v8H5v-8l7-5.5z" fill="#555"/>
                </svg>
                <span class="sidebar-label">Home</span>
              </button>
          
          <button id="btn-nav-library" class="add-flashcard-btn sidebar-btn" type="button">
            <!-- Folder SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" fill="#555"/>
            </svg>
            <span class="sidebar-label">Library</span>
          </button>
          
          <button id="btn-nav-themes" class="sidebar-icon-btn sidebar-btn" type="button">
            <!-- Color Palette SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.84 0 1.5-.66 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 8c-.83 0-1.5-.67-1.5-1.5S5.67 7 6.5 7s1.5.67 1.5 1.5S7.33 10 6.5 10zm3-4C8.67 6 8 5.33 8 4.5S8.67 3 9.5 3s1.5.67 1.5 1.5S10.33 6 9.5 6zM5.75 12.5c-.69 0-1.25-.56-1.25-1.25s.56-1.25 1.25-1.25 1.25.56 1.25 1.25-.56 1.25-1.25 1.25zM8.5 15c-.83 0-1.5-.67-1.5-1.5S7.67 12 8.5 12s1.5.67 1.5 1.5S9.33 15 8.5 15z" fill="#555"/>
            </svg>
            <span class="sidebar-label">Themes</span>
          </button>
          <button id="btn-nav-import" class="sidebar-icon-btn sidebar-btn" type="button">
            <!-- Import SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="#555"/>
            </svg>
            <span class="sidebar-label">Import</span>
          </button>


          <div class="sidebar-header-label">
            <span class="sidebar-label">Stuff</span>
          </div>
          
        </div>
      </div>
      



      <!-- Main Column -->
      <div id="sect-main" class="section-base main-content">
        <!-- Page Display Section -->
        <div id="view-home" class="page-panel">
          <div class="view-header">
            <div class="view-header-content">
              <h2 class="current-set-name">Home</h2>
              <p class="current-set-description">Welcome to your flashcard app</p>
              <span class="view-header-count card-count" style="display: none;">0 cards</span>
            </div>
            <div class="view-header-actions">
              <button class="new-set-btn" type="button">New Set</button>
              <button class="continue-with-btn" type="button" style="display: none;">Continue with: </button>
              <button class="add-flashcard-btn" type="button">Add Flashcard</button>
              <button class="header-completed-btn" title="Completed Cards" aria-label="Completed Cards">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z" fill="#555"/></svg>
                Completed Cards
              </button>
            </div>
          </div>
          <form class="new-set-form form-wrap form--hidden">
            <input class="new-set-name" type="text" placeholder="Set Name" required />
            <input class="new-set-desc" type="text" placeholder="Description" />
            <button type="submit">Add Set</button>
            <button type="button" class="cancel-new-set">Cancel</button>
          </form>
          <div id="home-card-sets-list" class="set-list list--stacked"></div>
        </div>

        <div id="view-library" class="page-panel" style="display:none">
          <div class="view-header">
            <div class="view-header-content">
              <h2 class="current-set-name">Library</h2>
              <p class="current-set-description">Manage your flashcard sets</p>
              <span class="view-header-count card-count" style="display: none;">0 cards</span>
            </div>
            <div class="view-header-actions">
              <button class="new-set-btn" type="button">New Set</button>
              <button class="continue-with-btn" type="button" style="display: none;">Continue with: </button>
              <button class="add-flashcard-btn" type="button">Add Flashcard</button>
              <button class="header-completed-btn" title="Completed Cards" aria-label="Completed Cards">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z" fill="#555"/></svg>
                Completed Cards
              </button>
            </div>
          </div>
          <form class="new-set-form form-wrap form--hidden">
            <input class="new-set-name" type="text" placeholder="Set Name" required />
            <input class="new-set-desc" type="text" placeholder="Description" />
            <button type="submit">Add Set</button>
            <button type="button" class="cancel-new-set">Cancel</button>
          </form>
          <div class="set-list"></div>
        </div>

        <div id="view-themes" class="page-panel" style="display:none">
          <div class="view-header">
            <div class="view-header-content">
              <h2 class="current-set-name">Themes</h2>
              <p class="current-set-description">Customize your experience</p>
              <span class="view-header-count card-count" style="display: none;">0 cards</span>
            </div>
            <div class="view-header-actions">
              <button class="new-set-btn" type="button">New Set</button>
              <button class="continue-with-btn" type="button" style="display: none;">Continue with: </button>
              <button class="add-flashcard-btn" type="button">Add Flashcard</button>
              <button class="header-completed-btn" title="Completed Cards" aria-label="Completed Cards">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z" fill="#555"/></svg>
                Completed Cards
              </button>
            </div>
          </div>
        </div>

        <div id="view-import" class="page-panel" style="display:none">
          <div class="view-header">
            <div class="view-header-content">
              <h2 class="current-set-name">Import</h2>
              <p class="current-set-description">Import your flashcard sets</p>
            </div>
          </div>
          <div class="import-content">
            <div class="import-section">
              <div class="import-header">
                <h3>Paste Your Flashcard Set</h3>
                <div class="import-actions">
                  <button id="btn-auto-format" class="import-btn" type="button" title="Automatically clean up and structure your pasted text">Auto-Format</button>
                  <button id="btn-validate-import" class="import-btn" type="button" disabled title="Check your input for errors and show a preview">Validate</button>
                  <button id="btn-clear-import" class="import-btn" type="button" title="Clear all text from the input area">Clear All</button>
                </div>
              </div>
              <div class="import-text-container">
                <textarea id="import-text" class="import-textarea" placeholder="Math Basics
Basic arithmetic questions

What is 2+2?
4

What is the quadratic formula?
The quadratic formula is:
x = (-b ± √(b² - 4ac)) / 2a

Where:
a, b, and c are coefficients
± means plus or minus
√ means square root"></textarea>
                <div class="import-text-footer" style="display: flex; justify-content: space-between; align-items: center;">
                  <span class="char-count">0 characters</span>
                  <button id="btn-import" class="import-btn" type="button" disabled title="Import the flashcard set if valid">Import</button>
                </div>
                <div id="import-errors" style="color: red; margin-top: 8px;"></div>
                <div id="import-preview" style="margin-top: 16px;"></div>
              </div>
              <div class="quick-examples" id="quick-examples-section">
                <h4 id="quick-examples-toggle" style="cursor:pointer;user-select:none;">Quick Examples &#9654;</h4>
                <div class="example-templates" id="quick-examples-templates" style="display:none;">
                  <div class="example-template">
                    <h5>Format Rules</h5>
                    <pre>• First line: Set Name (max 100 chars)
• Second line: Set Description (max 500 chars, optional)
• Blank line after set info
• Each card starts with a Question (max 1000 chars, single line)
• Answer can span multiple lines (max 1000 chars)
• Blank line between cards
• Maximum 100 cards per set</pre>
                  </div>
                  <div class="example-template">
                    <h5>Basic Math</h5>
                    <pre>Math Basics
Basic arithmetic questions

What is 2+2?
4

What is 5×5?
25</pre>
                    <button class="copy-template-btn" data-template="Math Basics
Basic arithmetic questions

What is 2+2?
4

What is 5×5?
25">Copy</button>
                  </div>
                  <div class="example-template">
                    <h5>Vocabulary</h5>
                    <pre>English Vocabulary
Common English words

What is the meaning of 'ubiquitous'?
Present, appearing, or found everywhere

What is the meaning of 'ephemeral'?
Lasting for a very short time</pre>
                    <button class="copy-template-btn" data-template="English Vocabulary
Common English words

What is the meaning of 'ubiquitous'?
Present, appearing, or found everywhere

What is the meaning of 'ephemeral'?
Lasting for a very short time">Copy</button>
                  </div>
                  <div class="example-template">
                    <h5>Programming</h5>
                    <pre>JavaScript Basics
Common JavaScript concepts

What is a closure?
A function that has access to variables from its outer scope, even after the outer function has returned

What is hoisting?
The process where JavaScript moves declarations to the top of their scope before code execution</pre>
                    <button class="copy-template-btn" data-template="JavaScript Basics
Common JavaScript concepts

What is a closure?
A function that has access to variables from its outer scope, even after the outer function has returned

What is hoisting?
The process where JavaScript moves declarations to the top of their scope before code execution">Copy</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="preview-section">
              <!-- New styled preview area will be rendered here -->
            </div>
          </div>
        </div>

        <div id="viewH-cards" class="page-panel" style="display:none">
          <div class="view-header">
            <div class="view-header-content">
              <h2 class="current-set-name"></h2>
              <p class="current-set-description"></p>
              <span class="view-header-count card-count" style="display: none;">0 cards</span>
            </div>
            <div class="view-header-actions">
              <button class="new-set-btn" type="button">New Set</button>
              <button class="continue-with-btn" type="button" style="display: none;">Continue with: </button>
              <button class="add-flashcard-btn" type="button">Add Flashcard</button>
              <button class="header-completed-btn" title="Completed Cards" aria-label="Completed Cards">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z" fill="#555"/></svg>
                Completed Cards
              </button>
            </div>
          </div>
          <form class="add-flashcard-form form-wrap form--hidden">
            <input class="flashcard-question" type="text" placeholder="Question" required />
            <input class="flashcard-answer" type="text" placeholder="Answer" required />
            <button type="submit">Add Card</button>
            <button type="button" class="cancel-add-flashcard">Cancel</button>
          </form>
          <div class="flashcard-list"></div>
        </div>

        <!-- New Play Cards View -->
        <div id="view-play-cards" class="page-panel section-base" style="display:none">
          <div class="view-header">
            <div class="view-header-content">
              <h2 id="play-current-set-name">Set Name - Play Flashcards</h2>
              <p id="play-current-set-description">Set description will appear here</p>
              <p id="play-card-count">0 cards</p>
            </div>
            <div class="view-header-actions">
              <button id="play-back-to-sets-btn" class="nav-btn">Back to Sets</button>
              <button id="play-exit-btn" class="nav-btn">Exit Play Mode</button>
            </div>
          </div>
          <div class="play-view-content">
            <div class="card-display-area">
              <div class="flashcard">
                <div class="flashcard-inner">
                  <div class="flashcard-front">
                    <div class="flashcard-content">
                      <h3>Question</h3>
                      <p id="play-question">Question will appear here</p>
                    </div>
                  </div>
                  <div class="flashcard-back">
                    <div class="flashcard-content">
                      <h3>Answer</h3>
                      <p id="play-answer">Answer will appear here</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="play-navigation">
              <button id="play-prev-btn" class="nav-btn">Previous</button>
              <button id="play-flip-btn" class="flip-btn">Flip</button>
              <button id="play-next-btn" class="nav-btn">Next</button>
              <button id="play-shuffle-btn" class="shuffle-btn">Shuffle</button>
            </div>
            <div class="play-progress">
              <div class="progress-bar">
                <div id="play-progress-fill" class="progress-fill"></div>
              </div>
              <p id="play-progress-text">Card 0 of 0</p>
              <p class="flip-hint">Click card or press Space to flip</p>
            </div>
          </div>
        </div>
      </div>
      



      <!-- Right Column -->
      <div id="sect-done" class="section-base sidebar-done is-hidden">
        <div class="section-header">
          <h2>Completed Cards</h2>
        </div>
        <div class="section-content">
          <!-- Completed cards will be loaded here -->
        </div>
      </div>
    </div>
    <script>
        // API Client
        const API = {
            async getAllSets() {
                console.log('API: Fetching all sets');
                const response = await fetch('/api/sets');
                if (!response.ok) {
                    console.error('API Error: Failed to fetch sets', response.status);
                    throw new Error('Failed to fetch sets');
                }
                return response.json();
            },
            async getSet(id) {
                console.log(`API: Fetching set ${id}`);
                const response = await fetch(`/api/sets/${id}`);
                if (!response.ok) {
                    console.error(`API Error: Failed to fetch set ${id}`, response.status);
                    throw new Error('Failed to fetch set');
                }
                return response.json();
            },
            async createSet(name, description) {
                console.log('API: Creating new set', { name, description });
                const response = await fetch('/api/sets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                if (!response.ok) {
                    console.error('API Error: Failed to create set', response.status);
                    throw new Error('Failed to create set');
                }
                return response.json();
            },
            async updateSet(id, name, description) {
                console.log(`API: Updating set ${id}`, { name, description });
                const response = await fetch(`/api/sets/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to update set ${id}`, response.status);
                    throw new Error('Failed to update set');
                }
                return response.json();
            },
            async deleteSet(id) {
                console.log(`API: Deleting set ${id}`);
                const response = await fetch(`/api/sets/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to delete set ${id}`, response.status);
                    throw new Error('Failed to delete set');
                }
            },
            async getCards(setId) {
                console.log(`API: Fetching cards for set ${setId}`);
                const response = await fetch(`/api/sets/${setId}/cards`);
                if (!response.ok) {
                    console.error(`API Error: Failed to fetch cards for set ${setId}`, response.status);
                    throw new Error('Failed to fetch cards');
                }
                return response.json();
            },
            async getCard(setId, cardId) {
                const response = await fetch(`/api/sets/${setId}/cards/${cardId}`);
                if (!response.ok) throw new Error('Failed to fetch card');
                return response.json();
            },
            async createCard(setId, question, answer) {
                console.log(`API: Creating card in set ${setId}`, { question, answer });
                const response = await fetch(`/api/sets/${setId}/cards`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, answer })
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to create card in set ${setId}`, response.status);
                    throw new Error('Failed to create card');
                }
                return response.json();
            },
            async updateCard(setId, cardId, question, answer, completed) {
                console.log(`API: Updating card ${cardId} in set ${setId}`, { question, answer, completed });
                const body = {};
                if (question !== null) body.question = question;
                if (answer !== null) body.answer = answer;
                if (completed !== undefined) body.completed = completed;
                
                const response = await fetch(`/api/sets/${setId}/cards/${cardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to update card ${cardId}`, response.status);
                    throw new Error('Failed to update card');
                }
                return response.json();
            },
            async deleteCard(setId, cardId) {
                console.log(`API: Deleting card ${cardId} from set ${setId}`);
                const response = await fetch(`/api/sets/${setId}/cards/${cardId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to delete card ${cardId}`, response.status);
                    throw new Error('Failed to delete card');
                }
            },
            async verifySetDeleted(setId) {
                console.log(`API: Verifying set ${setId} is deleted`);
                try {
                    await this.getSet(setId);
                    return false; // Set still exists
                } catch (error) {
                    if (error.message === 'Failed to fetch set') {
                        return true; // Set is gone
                    }
                    throw error; // Other error
                }
            },
            async getLastActiveSet() {
                const response = await fetch('/api/sets/settings/last-active-set');
                if (!response.ok) throw new Error('Failed to get last active set');
                const data = await response.json();
                return data.lastActiveSet;
            },
            async updateLastActiveSet(setId) {
                const response = await fetch('/api/sets/settings/last-active-set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setId })
                });
                if (!response.ok) throw new Error('Failed to update last active set');
                return await response.json();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Add logging to verify event handlers
            console.log('DOM Content Loaded - Initializing event handlers');
            
            const layout3col = document.querySelector('.app-layout');
            const colLeft = document.getElementById('sect-nav');
            const colRight = document.getElementById('sect-done');
            const toggleSetsPanel = document.getElementById('toggle-sets-panel');
            const toggleCompletedPanel = document.getElementById('toggle-completed-panel');
            const cardSetsList = document.getElementById('card-sets-list');
            const colRightCardsContainer = colRight.querySelector('.section-content');
            let currentSetId = null;
            // Inline Undo logic
            let undoTimeout = null;
            let lastDeletedCard = null;
            let lastDeletedFromDone = false;
            function showInlineUndo(container, index, message, undoCallback) {
                // Remove any existing undo bars
                container.querySelectorAll('.undo-bar').forEach(el => el.remove());
                // Create undo bar
                const undoBar = document.createElement('div');
                undoBar.className = 'undo-bar';
                undoBar.innerHTML = `${message} <button type="button">Undo</button>`;
                // Insert at the correct position
                if (container.children.length === 0 || index >= container.children.length) {
                    container.appendChild(undoBar);
                } else {
                    container.insertBefore(undoBar, container.children[index]);
                }
                // Undo logic
                undoBar.querySelector('button').onclick = () => {
                    clearTimeout(undoTimeout);
                    undoBar.remove();
                    if (undoCallback) undoCallback();
                };
                // Remove after 5 seconds
                undoTimeout = setTimeout(() => {
                    undoBar.remove();
                }, 5000);
            }
            function updateGrid() {
                const colRightVisible = colRight.classList.contains('is-visible');
                const isCollapsed = layout3col.classList.contains('left-collapsed');
                
                if (colRightVisible && !isCollapsed) {
                    layout3col.style.gridTemplateColumns = '220px 1fr 335px';
                } else if (colRightVisible && isCollapsed) {
                    layout3col.style.gridTemplateColumns = '56px 1fr 335px';
                } else if (!isCollapsed) {
                    layout3col.style.gridTemplateColumns = '220px 1fr 0';
                } else {
                    layout3col.style.gridTemplateColumns = '56px 1fr 0';
                }
            }
            // Load library into sidebar
            async function loadLibrary() {
                const homePanel = document.getElementById('view-home');
                const homeCardSetsList = homePanel ? homePanel.querySelector('.set-list') : null;
                const libraryPanel = document.getElementById('view-library');
                const libraryCardSetsList = libraryPanel ? libraryPanel.querySelector('.set-list') : null;
                
                if (homeCardSetsList) homeCardSetsList.innerHTML = '';
                if (libraryCardSetsList) libraryCardSetsList.innerHTML = '';
                
                try {
                    const library = await API.getAllSets();
                    if (library.length === 0) {
                        const defaultLibrary = await API.createSet('My First Library', 'Start adding flashcards to this library');
                        library.push(defaultLibrary);
                    }
                    
                    // Get last active library
                    const lastActiveLibrary = await API.getLastActiveSet();
                    const continueBtn = document.querySelector('.continue-with-btn');
                    if (continueBtn) continueBtn.style.display = 'none'; // Hide by default
                    
                    if (lastActiveLibrary && !currentSetId) {
                        const lastLibrary = library.find(set => String(set.id) === String(lastActiveLibrary));
                        if (lastLibrary && continueBtn) {
                            continueBtn.textContent = `Continue with: ${lastLibrary.name} Flashcards`;
                            continueBtn.style.display = 'inline-block';
                            continueBtn.onclick = () => {
                                currentSetId = lastLibrary.id;
                                switchToCardView(lastLibrary.id);
                                const currentPanel = document.getElementById('viewH-cards');
                                const currentSetName = currentPanel.querySelector('.current-set-name');
                                const currentSetDesc = currentPanel.querySelector('.current-set-description');
                                if (currentSetName) currentSetName.textContent = `${lastLibrary.name} Flashcards`;
                                if (currentSetDesc) currentSetDesc.textContent = lastLibrary.description || '';
                                loadDoneCards();
                            };
                        }
                    }
                    
                    library.forEach(set => {
                        const createSetElement = () => {
                            const setElement = document.createElement('div');
                            setElement.className = 'set-card' + (set.id === currentSetId ? ' is-active' : '');
                            setElement.innerHTML = `
                                <div class="set-content-view">
                                    <h3>${set.name}</h3>
                                    <p>${set.description || ''}</p>
                                    <div class="set-stats">
                                        <span class="card-count">0 cards</span>
                                    </div>
                                    <button class="edit-set-btn" data-id="${set.id}">Edit Set</button>
                                    <button class="edit-flashcards-btn" data-id="${set.id}">Edit Flashcards</button>
                                    <button class="delete-set-btn" data-id="${set.id}">Delete</button>
                                </div>
                                <form class="edit-set-form" data-id="${set.id}" style="display:none; margin-top:10px;">
                                    <input type="text" name="edit-set-name" value="${set.name}" style="width:90%; margin-bottom:5px;" required />
                                    <input type="text" name="edit-set-desc" value="${set.description || ''}" style="width:90%; margin-bottom:5px;" />
                                    <button type="submit">Save</button>
                                    <button type="button" class="cancel-edit-set-btn">Cancel</button>
                                </form>
                            `;
                            
                            // Load card count for this set
                            API.getCards(set.id).then(cards => {
                                const cardCount = cards.length;
                                const countElement = setElement.querySelector('.card-count');
                                if (countElement) {
                                    countElement.textContent = `${cardCount} card${cardCount !== 1 ? 's' : ''}`;
                                }
                            }).catch(error => {
                                console.error('Failed to load card count:', error);
                            });
                            
                            // Add event listeners
                            const setContentView = setElement.querySelector('.set-content-view');
                            if (setContentView) {
                                setContentView.addEventListener('click', async (e) => {
                                    // Don't trigger if clicking any button
                                    if (e.target.tagName === 'BUTTON') return;
                                    await showPlayView(set.id);
                                });
                            }
                            
                            const editFlashcardsBtn = setElement.querySelector('.edit-flashcards-btn');
                            if (editFlashcardsBtn) {
                                editFlashcardsBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    currentSetId = set.id;
                                    await API.updateLastActiveSet(set.id);
                                    showCardView(set.id);
                                    const currentPanel = document.getElementById('viewH-cards');
                                    const currentSetName = currentPanel.querySelector('.current-set-name');
                                    const currentSetDesc = currentPanel.querySelector('.current-set-description');
                                    if (currentSetName) currentSetName.textContent = `${set.name} - Edit Flashcards`;
                                    if (currentSetDesc) currentSetDesc.textContent = set.description || '';
                                    loadDoneCards();
                                });
                            }
                            
                            const editBtn = setElement.querySelector('.edit-set-btn');
                            if (editBtn) {
                                editBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const contentView = setElement.querySelector('.set-content-view');
                                    const editForm = setElement.querySelector('.edit-set-form');
                                    if (contentView) contentView.style.display = 'none';
                                    if (editForm) editForm.style.display = 'block';
                                });
                            }
                            
                            const cancelBtn = setElement.querySelector('.cancel-edit-set-btn');
                            if (cancelBtn) {
                                cancelBtn.addEventListener('click', (e) => {
                                    const contentView = setElement.querySelector('.set-content-view');
                                    const editForm = setElement.querySelector('.edit-set-form');
                                    if (contentView) contentView.style.display = 'block';
                                    if (editForm) editForm.style.display = 'none';
                                });
                            }
                            
                            const editForm = setElement.querySelector('.edit-set-form');
                            if (editForm) {
                                editForm.addEventListener('submit', async (e) => {
                                    e.preventDefault();
                                    const nameInput = editForm.querySelector('input[name="edit-set-name"]');
                                    const descInput = editForm.querySelector('input[name="edit-set-desc"]');
                                    if (!nameInput) return;
                                    
                                    const name = nameInput.value.trim();
                                    const desc = descInput ? descInput.value.trim() : '';
                                    
                                    try {
                                        await API.updateSet(set.id, name, desc);
                                        const contentView = setElement.querySelector('.set-content-view');
                                        if (contentView) contentView.style.display = 'block';
                                        if (editForm) editForm.style.display = 'none';
                                        loadLibrary();
                                        // If this set is active, update the main header too
                                        if (set.id === currentSetId) {
                                            const currentPanel = document.getElementById('viewH-cards');
                                            const currentSetName = currentPanel.querySelector('.current-set-name');
                                            const currentSetDesc = currentPanel.querySelector('.current-set-description');
                                            if (currentSetName) currentSetName.textContent = `${name} Flashcards`;
                                            if (currentSetDesc) currentSetDesc.textContent = desc;
                                        }
                                    } catch (error) {
                                        console.error('Failed to update set:', error);
                                        alert('Failed to update set. Please try again.');
                                    }
                                });
                            }
                            
                            const deleteBtn = setElement.querySelector('.delete-set-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    try {
                                        // Check if set has cards
                                        const cards = await API.getCards(set.id);
                                        const message = cards.length > 0 
                                            ? `This set contains ${cards.length} card(s). Deleting will remove all cards. Are you sure?`
                                            : 'Are you sure you want to delete this set?';
                                        
                                        if (confirm(message)) {
                                            // Delete all cards first
                                            for (const card of cards) {
                                                await API.deleteCard(set.id, card.id);
                                            }
                                            // Then delete the set
                                            await API.deleteSet(set.id);
                                            
                                            // Verify deletion
                                            const isDeleted = await API.verifySetDeleted(set.id);
                                            if (!isDeleted) {
                                                throw new Error('Set deletion verification failed');
                                            }
                                            
                                            loadLibrary();
                                            if (set.id === currentSetId) {
                                                currentSetId = null;
                                                const currentPanel = document.getElementById('viewH-cards');
                                                const currentSetName = currentPanel.querySelector('.current-set-name');
                                                const currentSetDesc = currentPanel.querySelector('.current-set-description');
                                                if (currentSetName) currentSetName.textContent = '';
                                                if (currentSetDesc) currentSetDesc.textContent = '';
                                                showPanel('view-home');
                                            }
                                        }
                                    } catch (error) {
                                        console.error('Failed to delete set:', error);
                                        alert('Failed to delete set. Please try again.');
                                    }
                                });
                            }
                            
                            return setElement;
                        };
                        
                        // Create separate elements for home and library views
                        const homeElement = createSetElement();
                        const libraryElement = createSetElement();
                        
                        // Add to both lists
                        if (homeCardSetsList) homeCardSetsList.appendChild(homeElement);
                        if (libraryCardSetsList) libraryCardSetsList.appendChild(libraryElement);
                    });
                } catch (error) {
                    console.error('Failed to load library:', error);
                    alert('Failed to load library. Please refresh the page.');
                }
            }
            // Load done cards
            async function loadDoneCards() {
                const colRightCardsContainer = colRight.querySelector('.section-content');
                if (!colRightCardsContainer) {
                    console.error('Completed cards container not found');
                    return;
                }

                colRightCardsContainer.innerHTML = '';
                
                if (!currentSetId) {
                    colRightCardsContainer.innerHTML = `
                        <div class="set-card">
                            Select a library to view completed cards
                        </div>
                    `;
                    return;
                }

                try {
                    const cards = await API.getCards(currentSetId);
                    const doneCardsList = cards.filter(card => card.completed);
                    
                    if (doneCardsList.length === 0) {
                        colRightCardsContainer.innerHTML = `
                            <div class="set-card">
                                No completed cards yet. Complete some cards to see them here!
                            </div>
                        `;
                        return;
                    }

                    doneCardsList.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'flashcard-card completed';
                        cardElement.innerHTML = `
                            <h3>${card.question}</h3>
                            <p>${card.answer}</p>
                            <button class="incomplete-card-btn" data-id="${card.id}">Activate</button>
                            <button class="delete-card-btn" data-id="${card.id}">Delete</button>
                        `;
                        colRightCardsContainer.appendChild(cardElement);
                    });

                    // Add event listeners for Activate and Delete
                    colRightCardsContainer.querySelectorAll('.incomplete-card-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = btn.getAttribute('data-id');
                            try {
                                await API.updateCard(currentSetId, id, null, null, false);
                                loadCards(currentSetId);
                                loadDoneCards();
                            } catch (error) {
                                console.error('Failed to activate card:', error);
                                alert('Failed to activate card. Please try again.');
                            }
                        });
                    });

                    colRightCardsContainer.querySelectorAll('.delete-card-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = btn.getAttribute('data-id');
                            try {
                                const cardToDelete = cards.find(card => card.id === id);
                                await API.deleteCard(currentSetId, id);
                                lastDeletedCard = cardToDelete;
                                lastDeletedFromDone = true;
                                
                                // Find the index of the card in the container
                                const cardDiv = btn.closest('.set-card');
                                const index = Array.from(colRightCardsContainer.children).indexOf(cardDiv);
                                
                                loadCards(currentSetId);
                                loadDoneCards();
                                
                                showInlineUndo(colRightCardsContainer, index, 'Card deleted.', async () => {
                                    // Undo: restore card
                                    try {
                                        await API.createCard(currentSetId, lastDeletedCard.question, lastDeletedCard.answer);
                                        await API.updateCard(currentSetId, lastDeletedCard.id, null, null, true);
                                        loadCards(currentSetId);
                                        loadDoneCards();
                                    } catch (error) {
                                        console.error('Failed to restore card:', error);
                                        alert('Failed to restore card. Please try again.');
                                    }
                                });
                            } catch (error) {
                                console.error('Failed to delete card:', error);
                                alert('Failed to delete card. Please try again.');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Failed to load completed cards:', error);
                    alert('Failed to load completed cards. Please try again.');
                }
            }
            // Load cards for a specific set
            async function loadCards(setId) {
                const cardViewPanel = document.getElementById('viewH-cards');
                if (!cardViewPanel) {
                    console.error('Card view panel not found');
                    return;
                }
                
                const cardList = cardViewPanel.querySelector('.flashcard-list');
                if (!cardList) {
                    console.error('Card list container not found');
                    return;
                }
                
                cardList.innerHTML = '';
                try {
                    const cards = await API.getCards(setId);
                    const activeCards = cards.filter(card => !card.completed);
                    
                    // Update header elements
                    const headerCardCount = cardViewPanel.querySelector('.view-header-count');
                    const currentSetName = cardViewPanel.querySelector('.current-set-name');
                    const currentSetDesc = cardViewPanel.querySelector('.current-set-description');
                    
                    if (headerCardCount) {
                        headerCardCount.textContent = `${cards.length} card${cards.length !== 1 ? 's' : ''}`;
                        headerCardCount.style.display = 'inline-block';
                    }
                    
                    // Get the set name and update the header
                    const set = await API.getSet(setId);
                    if (currentSetName) currentSetName.textContent = `${set.name} - Edit Flashcards`;
                    if (currentSetDesc) currentSetDesc.textContent = set.description || '';
                    
                    if (activeCards.length === 0) {
                        cardList.innerHTML = `
                            <div class="set-card">
                                No cards in this set yet. Click "Add Flashcard" to create one!
                            </div>
                        `;
                        return;
                    }
                    
                    activeCards.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'flashcard-card';
                        cardElement.innerHTML = `
                            <div class="card-content-view">
                                <h3>${card.question}</h3>
                                <p>${card.answer}</p>
                                <button class="done-card-btn" data-id="${card.id}">Mark Complete</button>
                                <button class="edit-card-btn" data-id="${card.id}">Edit Card</button>
                                <button class="delete-card-btn" data-id="${card.id}">Delete</button>
                            </div>
                            <form class="edit-card-form" data-id="${card.id}" style="display:none; margin-top:10px;">
                                <input type="text" name="edit-question" value="${card.question}" style="width:90%; margin-bottom:5px;" required />
                                <input type="text" name="edit-answer" value="${card.answer}" style="width:90%; margin-bottom:5px;" required />
                                <button type="submit">Save</button>
                                <button type="button" class="cancel-edit-btn">Cancel</button>
                            </form>
                        `;
                        cardList.appendChild(cardElement);
                    });
                    
                    // Add event listeners for card actions
                    cardList.querySelectorAll('.done-card-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = btn.getAttribute('data-id');
                            try {
                                await API.updateCard(setId, id, null, null, true);
                                loadCards(setId);
                                loadDoneCards();
                            } catch (error) {
                                console.error('Failed to mark card as complete:', error);
                                alert('Failed to mark card as complete. Please try again.');
                            }
                        });
                    });
                    
                    cardList.querySelectorAll('.edit-card-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const cardDiv = btn.closest('.flashcard-card');
                            const contentView = cardDiv.querySelector('.card-content-view');
                            const editForm = cardDiv.querySelector('.edit-card-form');
                            if (contentView) contentView.style.display = 'none';
                            if (editForm) editForm.style.display = 'block';
                        });
                    });
                    
                    cardList.querySelectorAll('.cancel-edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const cardDiv = btn.closest('.flashcard-card');
                            const contentView = cardDiv.querySelector('.card-content-view');
                            const editForm = cardDiv.querySelector('.edit-card-form');
                            if (contentView) contentView.style.display = 'block';
                            if (editForm) editForm.style.display = 'none';
                        });
                    });
                    
                    cardList.querySelectorAll('.edit-card-form').forEach(form => {
                        form.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const id = form.getAttribute('data-id');
                            const question = form.elements['edit-question'].value.trim();
                            const answer = form.elements['edit-answer'].value.trim();
                            try {
                                await API.updateCard(setId, id, question, answer);
                                loadCards(setId);
                            } catch (error) {
                                console.error('Failed to update card:', error);
                                alert('Failed to update card. Please try again.');
                            }
                        });
                    });
                    
                    cardList.querySelectorAll('.delete-card-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = btn.getAttribute('data-id');
                            const cardDiv = btn.closest('.flashcard-card');
                            const question = cardDiv.querySelector('h3').textContent;
                            const answer = cardDiv.querySelector('p').textContent;
                            const placeholder = document.createElement('div');
                            placeholder.className = 'set-card deleting';
                            placeholder.innerHTML = `
                                <div class="card-content-view">
                                    <h3>${question}</h3>
                                    <p>${answer}</p>
                                    <div class="deleting-status">Deleting...</div>
                                </div>
                            `;
                            const originalIndex = Array.from(cardList.children).indexOf(cardDiv);
                            cardDiv.remove();
                            if (cardList.children.length === 0 || originalIndex >= cardList.children.length) {
                                cardList.appendChild(placeholder);
                            } else {
                                cardList.insertBefore(placeholder, cardList.children[originalIndex]);
                            }
                            let deleteTimeout;
                            showInlineUndo(cardList, originalIndex, 'Card deleted.', () => {
                                clearTimeout(deleteTimeout);
                                placeholder.remove();
                                if (cardList.children.length === 0 || originalIndex >= cardList.children.length) {
                                    cardList.appendChild(cardDiv);
                                } else {
                                    cardList.insertBefore(cardDiv, cardList.children[originalIndex]);
                                }
                            });
                            deleteTimeout = setTimeout(async () => {
                                try {
                                    await API.deleteCard(setId, id);
                                    placeholder.remove();
                                    loadCards(setId);
                                } catch (error) {
                                    console.error('Failed to delete card:', error);
                                    alert('Failed to delete card. Please try again.');
                                    placeholder.remove();
                                    if (cardList.children.length === 0 || originalIndex >= cardList.children.length) {
                                        cardList.appendChild(cardDiv);
                                    } else {
                                        cardList.insertBefore(cardDiv, cardList.children[originalIndex]);
                                    }
                                }
                            }, 5000);
                        });
                    });
                } catch (error) {
                    console.error('Failed to load cards:', error);
                    alert('Failed to load cards. Please try again.');
                }
            }
            // Initialize event listeners
            function initializeEventListeners() {
                // Removed left panel toggle event handler; left panel is always visible
                if (toggleCompletedPanel && colRight) {
                    toggleCompletedPanel.addEventListener('click', () => {
                        colRight.classList.toggle('is-visible');
                        if (colRight.classList.contains('is-visible')) {
                            loadDoneCards();
                        }
                        updateGrid();
                    });
                }

                // Show library button
                const showLibraryBtn = document.getElementById('btn-nav-library');
                if (showLibraryBtn) {
                    showLibraryBtn.addEventListener('click', () => {
                        switchToLibraryView();
                    });
                }

                // Show home button
                const showHomeBtn = document.getElementById('btn-nav-home');
                if (showHomeBtn) {
                    showHomeBtn.addEventListener('click', () => {
                        showPanel('view-home');
                        const homePanel = document.getElementById('view-home');
                        
                        // Update header elements
                        const addFlashcard = homePanel.querySelector('.add-flashcard-btn');
                        const newSetBtn = homePanel.querySelector('.new-set-btn');
                        const headerCompletedBtn = homePanel.querySelector('.header-completed-btn');
                        const headerCardCount = homePanel.querySelector('.view-header-count');
                        const currentSetName = homePanel.querySelector('.current-set-name');
                        const currentSetDesc = homePanel.querySelector('.current-set-description');

                        if (addFlashcard) addFlashcard.style.display = 'none';
                        if (newSetBtn) newSetBtn.style.display = 'inline-block';
                        if (headerCompletedBtn) headerCompletedBtn.style.display = 'none';
                        if (headerCardCount) headerCardCount.style.display = 'none';
                        if (currentSetName) currentSetName.textContent = 'Home Set';
                        if (currentSetDesc) currentSetDesc.textContent = 'Welcome to your flashcard app';
                        
                        // Reload library to refresh card sets
                        loadLibrary();
                    });
                }

                // Show themes button
                const showThemesBtn = document.getElementById('btn-nav-themes');
                if (showThemesBtn) {
                    showThemesBtn.addEventListener('click', () => {
                        showPanel('view-themes');
                        const themesPanel = document.getElementById('view-themes');
                        
                        // Update header elements
                        const addFlashcard = themesPanel.querySelector('.add-flashcard-btn');
                        const newSetBtn = themesPanel.querySelector('.new-set-btn');
                        const headerCompletedBtn = themesPanel.querySelector('.header-completed-btn');
                        const headerCardCount = themesPanel.querySelector('.view-header-count');
                        const currentSetName = themesPanel.querySelector('.current-set-name');
                        const currentSetDesc = themesPanel.querySelector('.current-set-description');

                        if (addFlashcard) addFlashcard.style.display = 'none';
                        if (newSetBtn) newSetBtn.style.display = 'none';
                        if (headerCompletedBtn) headerCompletedBtn.style.display = 'none';
                        if (headerCardCount) headerCardCount.style.display = 'none';
                        if (currentSetName) currentSetName.textContent = 'Themes';
                        if (currentSetDesc) currentSetDesc.textContent = 'Customize your experience';
                    });
                }

                // Show import button
                const showImportBtn = document.getElementById('btn-nav-import');
                if (showImportBtn) {
                    showImportBtn.addEventListener('click', () => {
                        showPanel('view-import');
                        const importPanel = document.getElementById('view-import');
                        
                        // Update header elements
                        const addFlashcard = importPanel.querySelector('.add-flashcard-btn');
                        const newSetBtn = importPanel.querySelector('.new-set-btn');
                        const headerCompletedBtn = importPanel.querySelector('.header-completed-btn');
                        const headerCardCount = importPanel.querySelector('.view-header-count');
                        const currentSetName = importPanel.querySelector('.current-set-name');
                        const currentSetDesc = importPanel.querySelector('.current-set-description');

                        if (addFlashcard) addFlashcard.style.display = 'none';
                        if (newSetBtn) newSetBtn.style.display = 'none';
                        if (headerCompletedBtn) headerCompletedBtn.style.display = 'none';
                        if (headerCardCount) headerCardCount.style.display = 'none';
                        if (currentSetName) currentSetName.textContent = 'Import';
                        if (currentSetDesc) currentSetDesc.textContent = 'Import your flashcard sets';
                    });
                }

                // Add new set button
                document.querySelectorAll('.new-set-btn').forEach(newSetBtn => {
                    newSetBtn.addEventListener('click', () => {
                        // Find the current panel by walking up the DOM tree
                        const currentPanel = newSetBtn.closest('.page-panel');
                        if (!currentPanel) {
                            console.error('Could not find current panel');
                            return;
                        }
                        const form = currentPanel.querySelector('.new-set-form');
                        if (form) {
                            form.classList.remove('form--hidden');
                            newSetBtn.style.display = 'none';
                        }
                    });
                });

                // Cancel new set button
                document.querySelectorAll('.cancel-new-set').forEach(cancelNewSet => {
                    cancelNewSet.addEventListener('click', () => {
                        // Find the current panel by walking up the DOM tree
                        const currentPanel = cancelNewSet.closest('.page-panel');
                        if (!currentPanel) {
                            console.error('Could not find current panel');
                            return;
                        }
                        const form = currentPanel.querySelector('.new-set-form');
                        const newSetBtn = currentPanel.querySelector('.new-set-btn');
                        if (form) {
                            form.reset();
                            form.classList.add('form--hidden');
                        }
                        if (newSetBtn) newSetBtn.style.display = 'inline-block';
                    });
                });

                // New set form submission
                document.querySelectorAll('.new-set-form').forEach(newSetForm => {
                    newSetForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        // Find the current panel by walking up the DOM tree
                        const currentPanel = newSetForm.closest('.page-panel');
                        if (!currentPanel) {
                            console.error('Could not find current panel');
                            return;
                        }
                        const nameInput = currentPanel.querySelector('.new-set-name');
                        const descInput = currentPanel.querySelector('.new-set-desc');
                        if (!nameInput) return;
                        
                        const name = nameInput.value.trim();
                        const desc = descInput ? descInput.value.trim() : '';
                        if (!name) return;
                        
                        try {
                            await API.createSet(name, desc);
                            const form = currentPanel.querySelector('.new-set-form');
                            const btn = currentPanel.querySelector('.new-set-btn');
                            if (form) {
                                form.reset();
                                form.classList.add('form--hidden');
                            }
                            if (btn) btn.style.display = 'inline-block';
                            loadLibrary();
                        } catch (error) {
                            console.error('Failed to create set:', error);
                            alert('Failed to create set. Please try again.');
                        }
                    });
                });

                // Add flashcard button
                document.querySelectorAll('.add-flashcard-btn').forEach(addFlashcardBtn => {
                    addFlashcardBtn.addEventListener('click', () => {
                        // Only proceed if we're in the card view panel and have a currentSetId
                        const cardViewPanel = document.getElementById('viewH-cards');
                        if (!cardViewPanel || cardViewPanel.style.display !== 'block' || !currentSetId) {
                            return;
                        }
                        const form = cardViewPanel.querySelector('.add-flashcard-form');
                        if (form) {
                            form.classList.remove('form--hidden');
                            addFlashcardBtn.style.display = 'none';
                        }
                    });
                });

                // Cancel add flashcard button
                document.querySelectorAll('.cancel-add-flashcard').forEach(cancelAddFlashcard => {
                    cancelAddFlashcard.addEventListener('click', () => {
                        const currentPanel = document.getElementById('viewH-cards');
                        const form = currentPanel.querySelector('.add-flashcard-form');
                        const btn = currentPanel.querySelector('.add-flashcard-btn');
                        if (form) {
                            form.reset();
                            form.classList.add('form--hidden');
                        }
                        if (btn) btn.style.display = 'inline-block';
                    });
                });

                // Add flashcard form submission
                document.querySelectorAll('.add-flashcard-form').forEach(addFlashcardForm => {
                    addFlashcardForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const currentPanel = document.getElementById('viewH-cards');
                        const questionInput = currentPanel.querySelector('.flashcard-question');
                        const answerInput = currentPanel.querySelector('.flashcard-answer');
                        if (!questionInput || !answerInput) return;
                        
                        const question = questionInput.value.trim();
                        const answer = answerInput.value.trim();
                        if (!question || !answer) return;
                        
                        try {
                            await API.createCard(currentSetId, question, answer);
                            const form = currentPanel.querySelector('.add-flashcard-form');
                            const btn = currentPanel.querySelector('.add-flashcard-btn');
                            if (form) {
                                form.reset();
                                form.classList.add('form--hidden');
                            }
                            if (btn) btn.style.display = 'inline-block';
                            loadCards(currentSetId);
                        } catch (error) {
                            console.error('Failed to create card:', error);
                            alert('Failed to create card. Please try again.');
                        }
                    });
                });

                // Ensure hamburger toggles and calls updateGrid
                const navCollapseBtn = document.getElementById('btn-nav-hamburger');
                if (navCollapseBtn) {
                    navCollapseBtn.addEventListener('click', () => {
                        layout3col.classList.toggle('left-collapsed');
                        updateGrid();
                    });
                }
            }
            // Initialize the app
            initializeEventListeners();

            // Import Interface Functionality
            const importText = document.getElementById('import-text');
            const validateImportBtn = document.getElementById('btn-validate-import');
            const clearImportBtn = document.getElementById('btn-clear-import');
            const copyExampleBtn = document.getElementById('btn-copy-example');
            const formatHelpBtn = document.getElementById('btn-format-help');
            const importBtn = document.getElementById('btn-import');
            const charCount = document.querySelector('.char-count');
            const previewStatus = document.querySelector('.preview-status');
            const previewSetName = document.querySelector('.preview-set-name');
            const previewSetDescription = document.querySelector('.preview-set-description');
            const previewCardCount = document.querySelector('.preview-card-count');
            const previewCards = document.querySelector('.preview-cards');

            // Update character count
            function updateCharCount() {
                const count = importText.value.length;
                charCount.textContent = `${count} characters`;
                validateImportBtn.disabled = count === 0;
                importBtn.disabled = count === 0;
            }

            // Import functionality
            if (importBtn) {
                importBtn.addEventListener('click', () => {
                    // TODO: Implement import logic in Epic 6.2
                    console.log('Import clicked');
                });
            }

            // Clear import text
            function clearImportText() {
                importText.value = '';
                updateCharCount();
                previewStatus.textContent = 'No content to preview';
                previewSetName.textContent = 'Set Name';
                previewSetDescription.textContent = 'Set Description';
                previewCardCount.textContent = '0 cards';
                previewCards.innerHTML = '';
            }

            // Initialize import interface
            if (importText) {
                importText.addEventListener('input', updateCharCount);
                updateCharCount();
            }

            if (clearImportBtn) {
                clearImportBtn.addEventListener('click', clearImportText);
            }

            // --- Import Format Validation ---
            function validateImportFormat(text) {
                // Example format rules (customize as needed):
                // 1. First line: Set Name (required)
                // 2. Second line: Set Description (optional)
                // 3. Blank line
                // 4. Each card: Question (line), Answer (next line), blank line between cards
                const lines = text.split(/\r?\n/).map(l => l.trim());
                const errors = [];
                const warnings = [];
                let idx = 0;
                // Find set name
                while (idx < lines.length && !lines[idx]) idx++;
                if (idx >= lines.length) {
                    errors.push('Set name is required.');
                    return { errors, warnings };
                }
                const setName = lines[idx++];
                // Find set description (optional)
                while (idx < lines.length && !lines[idx]) idx++;
                let setDesc = '';
                if (idx < lines.length) setDesc = lines[idx++];
                // Skip blank lines
                while (idx < lines.length && !lines[idx]) idx++;
                // Parse cards
                let cardCount = 0;
                while (idx < lines.length) {
                    // Question
                    if (!lines[idx]) {
                        idx++;
                        continue;
                    }
                    const question = lines[idx++];
                    if (!question) {
                        errors.push(`Card ${cardCount + 1}: Question is required.`);
                        continue;
                    }
                    // Answer
                    while (idx < lines.length && !lines[idx]) idx++;
                    if (idx >= lines.length || !lines[idx]) {
                        errors.push(`Card ${cardCount + 1}: Answer is required.`);
                        break;
                    }
                    const answer = lines[idx++];
                    if (!answer) {
                        errors.push(`Card ${cardCount + 1}: Answer is required.`);
                        continue;
                    }
                    cardCount++;
                    // Skip blank lines between cards
                    while (idx < lines.length && !lines[idx]) idx++;
                }
                if (cardCount === 0) {
                    errors.push('At least one card is required.');
                }
                return { errors, warnings };
            }

            // --- Preview Rendering ---
            function renderImportPreview(text) {
                const previewDiv = document.getElementById('import-preview');
                previewDiv.innerHTML = '';
                const result = validateImportFormat(text);
                // Parse set name and description
                const lines = text.split(/\r?\n/).map(l => l.trim());
                let idx = 0;
                while (idx < lines.length && !lines[idx]) idx++;
                const setName = idx < lines.length ? lines[idx++] : '';
                while (idx < lines.length && !lines[idx]) idx++;
                const setDesc = idx < lines.length ? lines[idx++] : '';
                // Skip blank lines
                while (idx < lines.length && !lines[idx]) idx++;
                // Parse cards
                let cards = [];
                let currentCard = [];
                while (idx < lines.length) {
                    const line = lines[idx];
                    if (!line) {
                        if (currentCard.length) {
                            cards.push(currentCard);
                            currentCard = [];
                        }
                    } else {
                        currentCard.push(line);
                    }
                    idx++;
                }
                if (currentCard.length) cards.push(currentCard);
                // Build preview HTML
                let html = '';
                html += `<div class="preview-header" style="margin-bottom: 10px;"><h3 style="margin:0;">Preview</h3></div>`;
                html += `<div><strong>Set Name:</strong> ${setName || '<span style=\'color:#888\'>(none)</span>'}</div>`;
                html += `<div><strong>Description:</strong> ${setDesc || '<span style=\'color:#888\'>(none)</span>'}</div><br>`;
                cards.forEach((card, i) => {
                    html += `<div style="margin-bottom:10px;"><strong>Card ${i+1}:</strong><br>`;
                    if (card.length > 0) {
                        html += `<span style="color:#2563eb;font-weight:bold;">Q:</span> ${card[0]}<br>`;
                        if (card.length > 1) {
                            html += `<span style="color:#388e3c;font-weight:bold;">A:</span> ${card.slice(1).join('<br>')}`;
                        }
                    }
                    html += `</div>`;
                });
                html += `<br><hr style=\"margin:16px 0;\">`;
                html += `<div style="margin:8px 0;"><strong>Total cards:</strong> ${cards.length}</div>`;
                previewDiv.innerHTML = html;
            }

            if (validateImportBtn) {
                validateImportBtn.addEventListener('click', () => {
                    const text = importText.value.trim();
                    const result = validateImportFormat(text);
                    const errorDiv = document.getElementById('import-errors');
                    errorDiv.innerHTML = '';
                    if (result.errors.length > 0) {
                        result.errors.forEach(err => {
                            const p = document.createElement('div');
                            p.textContent = err;
                            errorDiv.appendChild(p);
                        });
                    } else if (result.warnings.length > 0) {
                        result.warnings.forEach(warn => {
                            const p = document.createElement('div');
                            p.textContent = warn;
                            p.style.color = 'orange';
                            errorDiv.appendChild(p);
                        });
                    }
                    renderImportPreview(text);
                });
            }

            // Copy example format
            if (copyExampleBtn) {
                copyExampleBtn.addEventListener('click', () => {
                    const exampleText = importText.placeholder;
                    navigator.clipboard.writeText(exampleText).then(() => {
                        const originalText = copyExampleBtn.textContent;
                        copyExampleBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyExampleBtn.textContent = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy example:', err);
                    });
                });
            }

            // Show format help
            if (formatHelpBtn) {
                formatHelpBtn.addEventListener('click', () => {
                    const helpText = `Format Rules:
1. First line: Set Name (max 100 chars)
2. Second line: Set Description (max 500 chars)
3. Blank line after set info
4. Each card starts with Question (max 1000 chars)
5. Answer can span multiple lines (max 1000 chars)
6. Blank line between cards
7. Maximum 100 cards per set

Example:
Math Basics
Basic arithmetic questions

What is 2+2?
4

What is the quadratic formula?
The quadratic formula is:
x = (-b ± √(b² - 4ac)) / 2a`;
                    alert(helpText);
                });
            }

            // Set initial view state
            const homePanel = document.getElementById('view-home');
            const libraryPanel = document.getElementById('view-library');
            const themesPanel = document.getElementById('view-themes');
            const importPanel = document.getElementById('view-import');
            const cardViewPanel = document.getElementById('viewH-cards');

            // Initialize all panels with their default states
            [homePanel, libraryPanel, themesPanel, importPanel, cardViewPanel].forEach(panel => {
                if (!panel) return;
                
                // Set default header states
                const addFlashcard = panel.querySelector('.add-flashcard-btn');
                const newSetBtn = panel.querySelector('.new-set-btn');
                const headerCompletedBtn = panel.querySelector('.header-completed-btn');
                const headerCardCount = panel.querySelector('.view-header-count');
                const currentSetName = panel.querySelector('.current-set-name');
                const currentSetDesc = panel.querySelector('.current-set-description');

                // Always hide Add Flashcard button in non-card-view panels
                if (addFlashcard) {
                    addFlashcard.style.display = 'none';
                    // Disable the button to prevent click events
                    addFlashcard.disabled = true;
                }
                if (newSetBtn) newSetBtn.style.display = 'none';
                if (headerCompletedBtn) headerCompletedBtn.style.display = 'none';
                if (headerCardCount) headerCardCount.style.display = 'none';
                
                // Set panel-specific defaults
                if (panel === homePanel) {
                    if (newSetBtn) newSetBtn.style.display = 'inline-block';
                    if (currentSetName) currentSetName.textContent = 'Home Set';
                    if (currentSetDesc) currentSetDesc.textContent = 'Welcome to your flashcard app';
                } else if (panel === libraryPanel) {
                    if (newSetBtn) newSetBtn.style.display = 'inline-block';
                    if (currentSetName) currentSetName.textContent = 'Library Set';
                    if (currentSetDesc) currentSetDesc.textContent = 'Manage your flashcard sets';
                } else if (panel === themesPanel) {
                    if (currentSetName) currentSetName.textContent = 'Themes';
                    if (currentSetDesc) currentSetDesc.textContent = 'Customize your experience';
                } else if (panel === importPanel) {
                    if (currentSetName) currentSetName.textContent = 'Import';
                    if (currentSetDesc) currentSetDesc.textContent = 'Import your flashcard sets';
                }
            });

            // Hide all panels except home
            document.querySelectorAll('#sect-main > .page-panel').forEach(panel => {
                if (panel !== homePanel) {
                    panel.style.display = 'none';
                }
            });

            // Show home panel
            if (homePanel) {
                homePanel.style.display = 'block';
            }

            // Set Home button as active
            const showHomeBtn = document.getElementById('btn-nav-home');
            if (showHomeBtn) showHomeBtn.classList.add('is-active');

            // Open sidebar by default
            if (colLeft) colLeft.classList.add('is-visible');
            updateGrid();

            // Load initial content
            loadLibrary();

            // Load the current set if one is selected
            if (currentSetId) {
                loadCards(currentSetId);
                loadLibrary(); // Ensure .is-active is applied
            }
            // Make toggleCardCompletion available globally
            window.toggleCardCompletion = async function(cardId) {
                try {
                    const card = await API.getCard(currentSetId, cardId);
                    await API.updateCard(currentSetId, cardId, null, null, !card.completed);
                    loadCards(currentSetId);
                    loadDoneCards();
                } catch (error) {
                    console.error('Failed to toggle card completion:', error);
                    alert('Failed to toggle card completion. Please try again.');
                }
            };
            // Add view switching function
            function showCardView(setId) {
                currentSetId = setId;  // Set the currentSetId
                showPanel('viewH-cards');
                const cardViewPanel = document.getElementById('viewH-cards');
                
                // Update header elements
                const addFlashcard = cardViewPanel.querySelector('.add-flashcard-btn');
                const newSetBtn = cardViewPanel.querySelector('.new-set-btn');
                const continueWithBtn = cardViewPanel.querySelector('.continue-with-btn');
                const headerCompletedBtn = cardViewPanel.querySelector('.header-completed-btn');
                const headerCardCount = cardViewPanel.querySelector('.view-header-count');
                const currentSetName = cardViewPanel.querySelector('.current-set-name');
                const currentSetDesc = cardViewPanel.querySelector('.current-set-description');
                
                // Only show and enable Add Flashcard button if we have a valid setId
                if (addFlashcard) {
                    addFlashcard.style.display = setId ? 'inline-block' : 'none';
                    addFlashcard.disabled = !setId;
                }
                if (newSetBtn) newSetBtn.style.display = 'none';
                if (continueWithBtn) continueWithBtn.style.display = 'none';
                if (headerCompletedBtn) headerCompletedBtn.style.display = setId ? 'inline-block' : 'none';
                if (headerCardCount) headerCardCount.style.display = setId ? 'inline-block' : 'none';
                
                // Set up the completed panel button
                if (headerCompletedBtn && colRight) {
                    headerCompletedBtn.onclick = () => {
                        colRight.classList.toggle('is-visible');
                        if (colRight.classList.contains('is-visible')) {
                            loadDoneCards();
                        }
                        updateGrid();
                    };
                }
                
                // Add Play Cards button
                addPlayButtonToCardView();
                
                // Load cards for the selected set
                if (setId) {
                    loadCards(setId);
                }
            }

            // Add play button to card view
            function addPlayButtonToCardView() {
                const cardViewPanel = document.getElementById('viewH-cards');
                const headerActions = cardViewPanel.querySelector('.view-header-actions');
                
                // Create play button if it doesn't exist
                if (!headerActions.querySelector('.play-cards-btn')) {
                    const playButton = document.createElement('button');
                    playButton.className = 'play-cards-btn';
                    playButton.type = 'button';
                    playButton.textContent = 'Play Cards';
                    playButton.addEventListener('click', () => {
                        showPlayView(currentSetId);
                    });
                    
                    // Insert before the "Add Flashcard" button
                    const addFlashcardBtn = headerActions.querySelector('.add-flashcard-btn');
                    headerActions.insertBefore(playButton, addFlashcardBtn);
                }
            }

            // Add play button when showing card view
            const originalShowCardView = showCardView;
            showCardView = function(setId) {
                originalShowCardView(setId);
                addPlayButtonToCardView();
            };

            // Play View Functions
            async function showPlayView(setId) {
                try {
                    // Show loading state
                    const playPanel = document.getElementById('view-play-cards');
                    playPanel.classList.add('loading');
                    
                    // Reset card state
                    currentCardIndex = 0;
                    isFlipped = false;
                    cards = [];
                    originalOrder = [];
                    
                    // Fetch set details and cards
                    const setDetails = await API.getSet(setId);
                    const fetchedCards = await API.getCards(setId);
                    
                    if (!fetchedCards || fetchedCards.length === 0) {
                        throw new Error('No cards found in this set');
                    }
                    
                    // Validate card data
                    cards = fetchedCards.filter(card => card && card.question && card.answer);
                    if (cards.length === 0) {
                        throw new Error('No valid cards found in this set');
                    }
                    
                    // Store original order
                    originalOrder = [...cards];
                    
                    // Update UI with set details
                    const setNameEl = document.getElementById('play-current-set-name');
                    const setDescEl = document.getElementById('play-current-set-description');
                    const cardCountEl = document.getElementById('play-card-count');
                    
                    if (setNameEl) setNameEl.textContent = `${setDetails.name} - Play Flashcards`;
                    if (setDescEl) setDescEl.textContent = setDetails.description || 'No description available';
                    if (cardCountEl) cardCountEl.textContent = `${cards.length} cards`;
                    
                    // Update card display
                    updateCardDisplay();
                    
                    // Add event listeners
                    const card = document.querySelector('.flashcard');
                    const prevBtn = document.getElementById('play-prev-btn');
                    const nextBtn = document.getElementById('play-next-btn');
                    const flipBtn = document.getElementById('play-flip-btn');
                    const shuffleBtn = document.getElementById('play-shuffle-btn');
                    const backToSetsBtn = document.getElementById('play-back-to-sets-btn');
                    const exitBtn = document.getElementById('play-exit-btn');
                    
                    // Remove existing listeners
                    if (card) card.removeEventListener('click', flipCard);
                    if (prevBtn) prevBtn.removeEventListener('click', showPreviousCard);
                    if (nextBtn) nextBtn.removeEventListener('click', showNextCard);
                    if (flipBtn) flipBtn.removeEventListener('click', flipCard);
                    if (shuffleBtn) shuffleBtn.removeEventListener('click', shuffleCards);
                    if (backToSetsBtn) backToSetsBtn.removeEventListener('click', () => showPanel('view-library'));
                    if (exitBtn) exitBtn.removeEventListener('click', () => showPanel('view-library'));
                    
                    // Add new listeners
                    if (card) card.addEventListener('click', flipCard);
                    if (prevBtn) prevBtn.addEventListener('click', showPreviousCard);
                    if (nextBtn) nextBtn.addEventListener('click', showNextCard);
                    if (flipBtn) flipBtn.addEventListener('click', flipCard);
                    if (shuffleBtn) shuffleBtn.addEventListener('click', shuffleCards);
                    if (backToSetsBtn) backToSetsBtn.addEventListener('click', () => showPanel('view-library'));
                    if (exitBtn) exitBtn.addEventListener('click', () => showPanel('view-library'));
                    
                    // Add keyboard shortcuts
                    const handleKeyPress = (e) => {
                        if (playPanel.style.display !== 'block') return;
                        
                        switch(e.key) {
                            case 'ArrowLeft':
                                showPreviousCard();
                                break;
                            case 'ArrowRight':
                                showNextCard();
                                break;
                            case ' ':
                            case 'Enter':
                                e.preventDefault();
                                flipCard();
                                break;
                        }
                    };
                    
                    document.removeEventListener('keydown', handleKeyPress);
                    document.addEventListener('keydown', handleKeyPress);
                    
                    // Show the panel
                    showPanel('view-play-cards');
                    
                    // Remove loading state
                    playPanel.classList.remove('loading');
                    
                } catch (error) {
                    console.error('Error in showPlayView:', error);
                    const playPanel = document.getElementById('view-play-cards');
                    playPanel.classList.remove('loading');
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.textContent = error.message || 'An error occurred while loading the cards';
                    
                    const content = playPanel.querySelector('.play-view-content');
                    if (content) {
                        content.innerHTML = '';
                        content.appendChild(errorDiv);
                        
                        // Add retry button
                        const retryBtn = document.createElement('button');
                        retryBtn.className = 'sidebar-btn';
                        retryBtn.textContent = 'Retry';
                        retryBtn.onclick = () => showPlayView(setId);
                        content.appendChild(retryBtn);
                    }
                    
                    showPanel('view-play-cards');
                }
            }

            function switchToLibraryView() {
                showPanel('view-library');
                const libraryPanel = document.getElementById('view-library');
                
                // Update header elements
                const addFlashcard = libraryPanel.querySelector('.add-flashcard-btn');
                const newSetBtn = libraryPanel.querySelector('.new-set-btn');
                const headerCompletedBtn = libraryPanel.querySelector('.header-completed-btn');
                const headerCardCount = libraryPanel.querySelector('.view-header-count');
                const currentSetName = libraryPanel.querySelector('.current-set-name');
                const currentSetDesc = libraryPanel.querySelector('.current-set-description');

                // Hide and disable Add Flashcard button in library view
                if (addFlashcard) {
                    addFlashcard.style.display = 'none';
                    addFlashcard.disabled = true;
                }
                if (newSetBtn) newSetBtn.style.display = 'inline-block';
                if (headerCompletedBtn) headerCompletedBtn.style.display = 'none';
                if (headerCardCount) headerCardCount.style.display = 'none';
                if (currentSetName) currentSetName.textContent = 'Library Set';
                if (currentSetDesc) currentSetDesc.textContent = 'Manage your flashcard sets';
                
                // Reload library to refresh card sets
                loadLibrary();
            }

            // Navigation Functions
            function showPanel(panelId) {
                // Hide all panels
                document.querySelectorAll('#sect-main > .page-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // Show the requested panel
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'block';
                    
                    // Update navigation button states
                    const navButtons = document.querySelectorAll('.sidebar-btn');
                    navButtons.forEach(btn => btn.classList.remove('is-active'));
                    
                    // Set the appropriate button as active
                    switch(panelId) {
                        case 'view-home':
                            const homeBtn = document.getElementById('btn-nav-home');
                            if (homeBtn) homeBtn.classList.add('is-active');
                            break;
                        case 'view-library':
                            const libraryBtn = document.getElementById('btn-nav-library');
                            if (libraryBtn) libraryBtn.classList.add('is-active');
                            break;
                        case 'view-themes':
                            const themesBtn = document.getElementById('btn-nav-themes');
                            if (themesBtn) themesBtn.classList.add('is-active');
                            break;
                        case 'view-import':
                            const importBtn = document.getElementById('btn-nav-import');
                            if (importBtn) importBtn.classList.add('is-active');
                            break;
                    }
                }
            }

            // Update the variables at the top of the script section
            let currentCardIndex = 0;
            let isFlipped = false;
            let cards = [];
            let originalOrder = [];

            function updateCardDisplay() {
                const questionEl = document.getElementById('play-question');
                const answerEl = document.getElementById('play-answer');
                const progressFill = document.getElementById('play-progress-fill');
                const progressText = document.getElementById('play-progress-text');
                const prevBtn = document.getElementById('play-prev-btn');
                const nextBtn = document.getElementById('play-next-btn');
                const flashcard = document.querySelector('.flashcard');
                
                if (!cards.length || !questionEl || !answerEl) return;
                
                // Update card content
                questionEl.textContent = cards[currentCardIndex].question;
                answerEl.textContent = cards[currentCardIndex].answer;
                
                // Reset flip state
                if (isFlipped && flashcard) {
                    flashcard.classList.remove('flipped');
                    isFlipped = false;
                }
                
                // Update progress
                const progress = ((currentCardIndex + 1) / cards.length) * 100;
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (progressText) progressText.textContent = `Card ${currentCardIndex + 1} of ${cards.length}`;
                
                // Update button states
                if (prevBtn) prevBtn.disabled = currentCardIndex === 0;
                if (nextBtn) nextBtn.disabled = currentCardIndex === cards.length - 1;
            }

            // Add these functions back after updateCardDisplay
            function flipCard() {
                const flashcard = document.querySelector('.flashcard');
                if (!flashcard) return;
                
                flashcard.classList.toggle('flipped');
                isFlipped = !isFlipped;
            }

            function showPreviousCard() {
                if (currentCardIndex > 0) {
                    currentCardIndex--;
                    updateCardDisplay();
                }
            }

            function showNextCard() {
                if (currentCardIndex < cards.length - 1) {
                    currentCardIndex++;
                    updateCardDisplay();
                }
            }

            function shuffleCards() {
                if (!cards.length) return;
                
                // Fisher-Yates shuffle algorithm
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }
                
                currentCardIndex = 0;
                updateCardDisplay();
            }

            // Copy template functionality
            document.querySelectorAll('.copy-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const template = btn.getAttribute('data-template');
                    navigator.clipboard.writeText(template).then(() => {
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy template:', err);
                    });
                });
            });

            // --- Improved Auto-Formatting (aligned to spec) ---
            function autoFormatImportText(text) {
                // Normalize line endings and trim trailing spaces
                let lines = text.replace(/\r\n?/g, '\n').split('\n').map(l => l.replace(/\s+$/, ''));
                // Remove leading blank lines
                while (lines.length && !lines[0].trim()) lines.shift();
                // Set name
                let idx = 0;
                let formatted = [];
                if (idx < lines.length) {
                    formatted.push(lines[idx++]); // Set name
                }
                // Set description
                while (idx < lines.length && !lines[idx].trim()) idx++;
                if (idx < lines.length) {
                    formatted.push(lines[idx++]); // Set description
                }
                // Blank line after set info
                formatted.push('');
                // Cards
                let cards = [];
                let currentCard = [];
                let inCard = false;
                while (idx < lines.length) {
                    const line = lines[idx];
                    if (!line.trim()) {
                        // Blank line: could be within answer or between cards
                        if (inCard) {
                            currentCard.push(''); // preserve blank line within answer
                        } else {
                            // Multiple blank lines between cards are allowed
                        }
                    } else {
                        // If this is a question (line ends with '?') and currentCard is not empty, treat as new card
                        if (line.trim().endsWith('?') && currentCard.length > 0) {
                            cards.push(currentCard);
                            currentCard = [];
                        }
                        currentCard.push(line);
                        inCard = true;
                    }
                    // If next line is blank and currentCard is not empty, treat as card separator
                    if (inCard && (!line.trim()) && currentCard.length > 0) {
                        cards.push(currentCard);
                        currentCard = [];
                        inCard = false;
                    }
                    idx++;
                }
                if (currentCard.length) cards.push(currentCard);
                // Format cards: question, answer(s), preserve blank lines within answers, allow multiple blank lines between cards
                cards.forEach((card, i) => {
                    if (card.length) {
                        formatted.push(card[0]); // Question
                        if (card.length > 1) {
                            for (let j = 1; j < card.length; ++j) {
                                formatted.push(card[j]); // Answer lines (including blank lines)
                            }
                        }
                        // Only add a blank line between cards, not after the last card
                        if (i < cards.length - 1) formatted.push('');
                    }
                });
                // Remove trailing blank lines
                while (formatted.length && !formatted[formatted.length-1].trim()) formatted.pop();
                return formatted.join('\n');
            }

            const autoFormatBtn = document.getElementById('btn-auto-format');
            if (autoFormatBtn) {
                autoFormatBtn.addEventListener('click', () => {
                    const text = importText.value;
                    const formatted = autoFormatImportText(text);
                    importText.value = formatted;
                    // Optionally, update character count and errors
                    if (typeof updateCharCount === 'function') updateCharCount();
                    const errorDiv = document.getElementById('import-errors');
                    if (errorDiv) errorDiv.innerHTML = '';
                });
            }

            // Expand/collapse Quick Examples
            const quickExamplesToggle = document.getElementById('quick-examples-toggle');
            const quickExamplesTemplates = document.getElementById('quick-examples-templates');
            if (quickExamplesToggle && quickExamplesTemplates) {
                quickExamplesToggle.addEventListener('click', () => {
                    const isCollapsed = quickExamplesTemplates.style.display === 'none';
                    quickExamplesTemplates.style.display = isCollapsed ? '' : 'none';
                    quickExamplesToggle.innerHTML = `Quick Examples ${isCollapsed ? '&#9660;' : '&#9654;'}`;
                });
            }
        });
    </script>
  </body>
</html>
