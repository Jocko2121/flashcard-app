<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flashcard App</title>
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/layout.css">
    <link rel="stylesheet" href="styles/components.css">
    <style>
        /* Reserved for debugging and testing */
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="controls">
        <!-- Removed 'Toggle Library' and 'Toggle Completed' buttons -->
      </div>
    </div>
    <div class="layout-3col">
      <!-- Left Column -->
      <div id="col-left" class="panel-base panel-left panel-visible">
        <div class="panel-header nav-header">
          <button id="nav-collapse-btn" class="nav-icon-btn" title="Collapse/Expand Navigation" aria-label="Collapse/Expand Navigation">
            <!-- Hamburger SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect y="4" width="24" height="2" rx="1" fill="#555"/><rect y="11" width="24" height="2" rx="1" fill="#555"/><rect y="18" width="24" height="2" rx="1" fill="#555"/></svg>
          </button>
        </div>
        <div class="panel-content nav-content">
            <button id="show-home" class="sidebar-nav-btn active" type="button">
                <!-- Home SVG -->
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 9l2 1.5V20h16V10.5L22 9l-10-7zM12 4.5L19 10v8H5v-8l7-5.5z" fill="#555"/>
                </svg>
                <span class="nav-label">Home</span>
              </button>
          
          <button id="show-card-sets" class="add-flashcard-btn sidebar-nav-btn" type="button">
            <!-- Folder SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" fill="#555"/>
            </svg>
            <span class="nav-label">Library</span>
          </button>
          
          <button id="show-themes" class="nav-icon-btn sidebar-nav-btn" type="button">
            <!-- Color Palette SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.84 0 1.5-.66 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 8c-.83 0-1.5-.67-1.5-1.5S5.67 7 6.5 7s1.5.67 1.5 1.5S7.33 10 6.5 10zm3-4C8.67 6 8 5.33 8 4.5S8.67 3 9.5 3s1.5.67 1.5 1.5S10.33 6 9.5 6zM5.75 12.5c-.69 0-1.25-.56-1.25-1.25s.56-1.25 1.25-1.25 1.25.56 1.25 1.25-.56 1.25-1.25 1.25zM8.5 15c-.83 0-1.5-.67-1.5-1.5S7.67 12 8.5 12s1.5.67 1.5 1.5S9.33 15 8.5 15z" fill="#555"/>
            </svg>
            <span class="nav-label">Themes</span>
          </button>
          <button id="show-import" class="nav-icon-btn sidebar-nav-btn" type="button">
            <!-- Import SVG -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="#555"/>
            </svg>
            <span class="nav-label">Import</span>
          </button>


          <div class="nav-header-label">
            <span class="nav-label">Stuff</span>
          </div>
          
        </div>
      </div>
      
      <!-- Main Column -->
      <div class="panel-base panel-main">
        <!-- Main Header (Set Title and Add Flashcard) -->
        <div class="main-header">
          <div class="main-header-content">
            <h2 id="current-set-name">Home</h2>
            <p id="current-set-description"></p>
            <span id="header-card-count" class="card-count" style="display: none;">0 cards</span>
          </div>
          <div class="header-buttons">
            <button id="new-set-btn" class="new-set-btn" type="button">New Set</button>
            <button id="continue-with-btn" type="button" style="display: none;">Continue with: </button>
            <button id="add-flashcard" class="add-flashcard-btn" type="button">Add Flashcard</button>
            <button id="header-completed-btn" title="Completed Cards" aria-label="Completed Cards">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z" fill="#555"/></svg>
                Completed Cards
            </button>
          </div>
        </div>
        <form id="new-set-form" class="form-container hidden">
          <input id="new-set-name" type="text" placeholder="Set Name" required />
          <input id="new-set-desc" type="text" placeholder="Description" />
          <button type="submit">Add Set</button>
          <button type="button" id="cancel-new-set">Cancel</button>
        </form>
        <form id="add-flashcard-form" class="form-container hidden">
          <input id="flashcard-question" type="text" placeholder="Question" required />
          <input id="flashcard-answer" type="text" placeholder="Answer" required />
          <button type="submit">Add Card</button>
          <button type="button" id="cancel-add-flashcard">Cancel</button>
        </form>
        <!-- Flashcard Display Section -->
        <div id="card-con">
          <div id="card-sets-list" class="panel-content">
            <!-- Library will be loaded here -->
          </div>
          <div class="card-list-container">
            <!-- Cards will be loaded here -->
          </div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div id="col-right" class="panel-base panel-right panel-hidden">
        <div class="panel-header">
          <h2>Completed Cards</h2>
        </div>
        <div class="panel-content">
          <!-- Completed cards will be loaded here -->
        </div>
      </div>
    </div>
    <script>
        // API Client
        const API = {
            async getAllSets() {
                console.log('API: Fetching all sets');
                const response = await fetch('/api/sets');
                if (!response.ok) {
                    console.error('API Error: Failed to fetch sets', response.status);
                    throw new Error('Failed to fetch sets');
                }
                return response.json();
            },
            async getSet(id) {
                console.log(`API: Fetching set ${id}`);
                const response = await fetch(`/api/sets/${id}`);
                if (!response.ok) {
                    console.error(`API Error: Failed to fetch set ${id}`, response.status);
                    throw new Error('Failed to fetch set');
                }
                return response.json();
            },
            async createSet(name, description) {
                console.log('API: Creating new set', { name, description });
                const response = await fetch('/api/sets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                if (!response.ok) {
                    console.error('API Error: Failed to create set', response.status);
                    throw new Error('Failed to create set');
                }
                return response.json();
            },
            async updateSet(id, name, description) {
                console.log(`API: Updating set ${id}`, { name, description });
                const response = await fetch(`/api/sets/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to update set ${id}`, response.status);
                    throw new Error('Failed to update set');
                }
                return response.json();
            },
            async deleteSet(id) {
                console.log(`API: Deleting set ${id}`);
                const response = await fetch(`/api/sets/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to delete set ${id}`, response.status);
                    throw new Error('Failed to delete set');
                }
            },
            async getCards(setId) {
                console.log(`API: Fetching cards for set ${setId}`);
                const response = await fetch(`/api/sets/${setId}/cards`);
                if (!response.ok) {
                    console.error(`API Error: Failed to fetch cards for set ${setId}`, response.status);
                    throw new Error('Failed to fetch cards');
                }
                return response.json();
            },
            async getCard(setId, cardId) {
                const response = await fetch(`/api/sets/${setId}/cards/${cardId}`);
                if (!response.ok) throw new Error('Failed to fetch card');
                return response.json();
            },
            async createCard(setId, question, answer) {
                console.log(`API: Creating card in set ${setId}`, { question, answer });
                const response = await fetch(`/api/sets/${setId}/cards`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, answer })
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to create card in set ${setId}`, response.status);
                    throw new Error('Failed to create card');
                }
                return response.json();
            },
            async updateCard(setId, cardId, question, answer, completed) {
                console.log(`API: Updating card ${cardId} in set ${setId}`, { question, answer, completed });
                const body = {};
                if (question !== null) body.question = question;
                if (answer !== null) body.answer = answer;
                if (completed !== undefined) body.completed = completed;
                
                const response = await fetch(`/api/sets/${setId}/cards/${cardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to update card ${cardId}`, response.status);
                    throw new Error('Failed to update card');
                }
                return response.json();
            },
            async deleteCard(setId, cardId) {
                console.log(`API: Deleting card ${cardId} from set ${setId}`);
                const response = await fetch(`/api/sets/${setId}/cards/${cardId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    console.error(`API Error: Failed to delete card ${cardId}`, response.status);
                    throw new Error('Failed to delete card');
                }
            },
            async verifySetDeleted(setId) {
                console.log(`API: Verifying set ${setId} is deleted`);
                try {
                    await this.getSet(setId);
                    return false; // Set still exists
                } catch (error) {
                    if (error.message === 'Failed to fetch set') {
                        return true; // Set is gone
                    }
                    throw error; // Other error
                }
            },
            async getLastActiveSet() {
                const response = await fetch('/api/sets/settings/last-active-set');
                if (!response.ok) throw new Error('Failed to get last active set');
                const data = await response.json();
                return data.lastActiveSet;
            },
            async updateLastActiveSet(setId) {
                const response = await fetch('/api/sets/settings/last-active-set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setId })
                });
                if (!response.ok) throw new Error('Failed to update last active set');
                return await response.json();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Add logging to verify event handlers
            console.log('DOM Content Loaded - Initializing event handlers');
            
            const layout3col = document.querySelector('.layout-3col');
            const colLeft = document.getElementById('col-left');
            const colRight = document.getElementById('col-right');
            const toggleSetsPanel = document.getElementById('toggle-sets-panel');
            const toggleCompletedPanel = document.getElementById('toggle-completed-panel');
            const cardSetsList = document.getElementById('card-sets-list');
            const colRightCardsContainer = colRight.querySelector('.panel-content');
            let currentSetId = null;
            // Inline Undo logic
            let undoTimeout = null;
            let lastDeletedCard = null;
            let lastDeletedFromDone = false;
            function showInlineUndo(container, index, message, undoCallback) {
                // Remove any existing undo bars
                container.querySelectorAll('.undo-bar').forEach(el => el.remove());
                // Create undo bar
                const undoBar = document.createElement('div');
                undoBar.className = 'undo-bar';
                undoBar.innerHTML = `${message} <button type="button">Undo</button>`;
                // Insert at the correct position
                if (container.children.length === 0 || index >= container.children.length) {
                    container.appendChild(undoBar);
                } else {
                    container.insertBefore(undoBar, container.children[index]);
                }
                // Undo logic
                undoBar.querySelector('button').onclick = () => {
                    clearTimeout(undoTimeout);
                    undoBar.remove();
                    if (undoCallback) undoCallback();
                };
                // Remove after 5 seconds
                undoTimeout = setTimeout(() => {
                    undoBar.remove();
                }, 5000);
            }
            function updateGrid() {
                const colRightVisible = colRight.classList.contains('panel-visible');
                const isCollapsed = layout3col.classList.contains('left-collapsed');
                
                if (colRightVisible && !isCollapsed) {
                    layout3col.style.gridTemplateColumns = '220px 1fr 335px';
                } else if (colRightVisible && isCollapsed) {
                    layout3col.style.gridTemplateColumns = '56px 1fr 335px';
                } else if (!isCollapsed) {
                    layout3col.style.gridTemplateColumns = '220px 1fr 0';
                } else {
                    layout3col.style.gridTemplateColumns = '56px 1fr 0';
                }
            }
            // Load library into sidebar
            async function loadLibrary() {
                cardSetsList.innerHTML = '';
                try {
                    const library = await API.getAllSets();
                    if (library.length === 0) {
                        // Add a default library if none exist
                        const defaultLibrary = await API.createSet('My First Library', 'Start adding flashcards to this library');
                        library.push(defaultLibrary);
                    }
                    
                    // Get last active library
                    const lastActiveLibrary = await API.getLastActiveSet();
                    const continueBtn = document.getElementById('continue-with-btn');
                    continueBtn.style.display = 'none'; // Hide by default
                    
                    if (lastActiveLibrary && !currentSetId) {
                        const lastLibrary = library.find(set => String(set.id) === String(lastActiveLibrary));
                        if (lastLibrary) {
                            continueBtn.textContent = `Continue with: ${lastLibrary.name}`;
                            continueBtn.style.display = 'inline-block';
                            continueBtn.onclick = () => {
                                currentSetId = lastLibrary.id;
                                switchToCardView(lastLibrary.id);
                                document.getElementById('current-set-name').textContent = lastLibrary.name;
                                document.getElementById('current-set-description').textContent = lastLibrary.description || '';
                                loadDoneCards();
                            };
                        }
                    }
                    
                    library.forEach(set => {
                        const setElement = document.createElement('div');
                        setElement.className = 'card-set' + (set.id === currentSetId ? ' active' : '');
                        setElement.innerHTML = `
                            <div class="set-content-view">
                                <h3>${set.name}</h3>
                                <p>${set.description || ''}</p>
                                <div class="set-stats">
                                    <span class="card-count">0 cards</span>
                                </div>
                                <button class="edit-set-btn" data-id="${set.id}">Edit</button>
                                <button class="delete-set-btn" data-id="${set.id}">Delete</button>
                            </div>
                            <form class="edit-set-form" data-id="${set.id}" style="display:none; margin-top:10px;">
                                <input type="text" name="edit-set-name" value="${set.name}" style="width:90%; margin-bottom:5px;" required />
                                <input type="text" name="edit-set-desc" value="${set.description || ''}" style="width:90%; margin-bottom:5px;" />
                                <button type="submit">Save</button>
                                <button type="button" class="cancel-edit-set-btn">Cancel</button>
                            </form>
                        `;
                        // Load card count for this set
                        API.getCards(set.id).then(cards => {
                            const cardCount = cards.length;
                            const countElement = setElement.querySelector('.card-count');
                            countElement.textContent = `${cardCount} card${cardCount !== 1 ? 's' : ''}`;
                        }).catch(error => {
                            console.error('Failed to load card count:', error);
                        });
                        setElement.querySelector('.set-content-view').addEventListener('click', async (e) => {
                            // Only trigger set selection if not clicking the edit button
                            if (e.target.classList.contains('edit-set-btn')) return;
                            currentSetId = set.id;
                            await API.updateLastActiveSet(set.id);
                            switchToCardView(set.id);
                            document.getElementById('current-set-name').textContent = set.name;
                            document.getElementById('current-set-description').textContent = set.description || '';
                            loadDoneCards();
                        });
                        setElement.querySelector('.edit-set-btn').addEventListener('click', (e) => {
                            e.stopPropagation();
                            setElement.querySelector('.set-content-view').style.display = 'none';
                            setElement.querySelector('.edit-set-form').style.display = 'block';
                        });
                        setElement.querySelector('.cancel-edit-set-btn').addEventListener('click', (e) => {
                            setElement.querySelector('.edit-set-form').style.display = 'none';
                            setElement.querySelector('.set-content-view').style.display = 'block';
                        });
                        setElement.querySelector('.edit-set-form').addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const name = setElement.querySelector('input[name="edit-set-name"]').value.trim();
                            const desc = setElement.querySelector('input[name="edit-set-desc"]').value.trim();
                            try {
                                await API.updateSet(set.id, name, desc);
                                setElement.querySelector('.edit-set-form').style.display = 'none';
                                setElement.querySelector('.set-content-view').style.display = 'block';
                                loadLibrary();
                                // If this set is active, update the main header too
                                if (set.id === currentSetId) {
                                    document.getElementById('current-set-name').textContent = name;
                                    document.getElementById('current-set-description').textContent = desc;
                                }
                            } catch (error) {
                                console.error('Failed to update set:', error);
                                alert('Failed to update set. Please try again.');
                            }
                        });
                        setElement.querySelector('.delete-set-btn').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            try {
                                // Check if set has cards
                                const cards = await API.getCards(set.id);
                                const message = cards.length > 0 
                                    ? `This set contains ${cards.length} card(s). Deleting will remove all cards. Are you sure?`
                                    : 'Are you sure you want to delete this set?';
                                
                                if (confirm(message)) {
                                    // Delete all cards first
                                    for (const card of cards) {
                                        await API.deleteCard(set.id, card.id);
                                    }
                                    // Then delete the set
                                    await API.deleteSet(set.id);
                                    
                                    // Verify deletion
                                    const isDeleted = await API.verifySetDeleted(set.id);
                                    if (!isDeleted) {
                                        throw new Error('Set deletion verification failed');
                                    }
                                    
                                    loadLibrary();
                                    if (set.id === currentSetId) {
                                        currentSetId = null;
                                        document.getElementById('current-set-name').textContent = '';
                                        document.getElementById('current-set-description').textContent = '';
                                        document.querySelector('.card-list-container').innerHTML = '';
                                    }
                                }
                            } catch (error) {
                                console.error('Failed to delete set:', error);
                                alert('Failed to delete set. Please try again.');
                            }
                        });
                        cardSetsList.appendChild(setElement);
                    });
                } catch (error) {
                    console.error('Failed to load library:', error);
                    alert('Failed to load library. Please refresh the page.');
                }
            }
            // Load done cards
            async function loadDoneCards() {
                colRightCardsContainer.innerHTML = '';
                if (!currentSetId) {
                    colRightCardsContainer.innerHTML = `
                        <div class="card-set">
                            Select a library to view completed cards
                        </div>
                    `;
                    return;
                }
                try {
                    const cards = await API.getCards(currentSetId);
                    const doneCardsList = cards.filter(card => card.completed);
                    if (doneCardsList.length === 0) {
                        colRightCardsContainer.innerHTML = `
                            <div class="card-set">
                                No completed cards yet. Complete some cards to see them here!
                            </div>
                        `;
                    } else {
                        doneCardsList.forEach(card => {
                            const cardElement = document.createElement('div');
                            cardElement.className = 'card-set completed';
                            cardElement.innerHTML = `
                                <h3>${card.question}</h3>
                                <p>${card.answer}</p>
                                <button class="incomplete-card-btn" data-id="${card.id}">Activate</button>
                                <button class="delete-card-btn" data-id="${card.id}">Delete</button>
                            `;
                            colRightCardsContainer.appendChild(cardElement);
                        });
                        // Add event listeners for Activate and Delete
                        colRightCardsContainer.querySelectorAll('.incomplete-card-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = btn.getAttribute('data-id');
                                try {
                                    await API.updateCard(currentSetId, id, null, null, false);
                                    loadCards(currentSetId);
                                    loadDoneCards();
                                } catch (error) {
                                    console.error('Failed to activate card:', error);
                                    alert('Failed to activate card. Please try again.');
                                }
                            });
                        });
                        colRightCardsContainer.querySelectorAll('.delete-card-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = btn.getAttribute('data-id');
                                try {
                                    const cardToDelete = cards.find(card => card.id === id);
                                    await API.deleteCard(currentSetId, id);
                                    lastDeletedCard = cardToDelete;
                                    lastDeletedFromDone = true;
                                    // Find the index of the card in the container
                                    const cardDiv = btn.closest('.card-set');
                                    const index = Array.from(colRightCardsContainer.children).indexOf(cardDiv);
                                    loadCards(currentSetId);
                                    loadDoneCards();
                                    showInlineUndo(colRightCardsContainer, index, 'Card deleted.', async () => {
                                        // Undo: restore card
                                        try {
                                            await API.createCard(currentSetId, lastDeletedCard.question, lastDeletedCard.answer);
                                            await API.updateCard(currentSetId, lastDeletedCard.id, null, null, true);
                                            loadCards(currentSetId);
                                            loadDoneCards();
                                        } catch (error) {
                                            console.error('Failed to restore card:', error);
                                            alert('Failed to restore card. Please try again.');
                                        }
                                    });
                                } catch (error) {
                                    console.error('Failed to delete card:', error);
                                    alert('Failed to delete card. Please try again.');
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('Failed to load completed cards:', error);
                    alert('Failed to load completed cards. Please try again.');
                }
            }
            // Load cards for a specific set
            async function loadCards(setId) {
                const cardContainer = document.querySelector('.card-list-container');
                cardContainer.innerHTML = '';
                try {
                    const cards = await API.getCards(setId);
                    const activeCards = cards.filter(card => !card.completed);
                    
                    // Update the header card count
                    const headerCardCount = document.getElementById('header-card-count');
                    headerCardCount.textContent = `${cards.length} card${cards.length !== 1 ? 's' : ''}`;
                    headerCardCount.style.display = 'inline-block';
                    
                    if (activeCards.length === 0) {
                        cardContainer.innerHTML = `
                            <div class="card-set">
                                No cards in this set yet. Click "Add Flashcard" to create one!
                            </div>
                        `;
                        return;
                    }
                    activeCards.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = `card-set`;
                        cardElement.innerHTML = `
                            <div class="card-content-view">
                                <h3>${card.question}</h3>
                                <p>${card.answer}</p>
                                <button class="done-card-btn" data-id="${card.id}">Mark Complete</button>
                                <button class="edit-card-btn" data-id="${card.id}">Edit</button>
                                <button class="delete-card-btn" data-id="${card.id}">Delete</button>
                            </div>
                            <form class="edit-card-form" data-id="${card.id}" style="display:none; margin-top:10px;">
                                <input type="text" name="edit-question" value="${card.question}" style="width:90%; margin-bottom:5px;" required />
                                <input type="text" name="edit-answer" value="${card.answer}" style="width:90%; margin-bottom:5px;" required />
                                <button type="submit">Save</button>
                                <button type="button" class="cancel-edit-btn">Cancel</button>
                            </form>
                        `;
                        cardContainer.appendChild(cardElement);
                    });
                    // Add event listeners for done/edit/delete
                    cardContainer.querySelectorAll('.done-card-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = btn.getAttribute('data-id');
                            try {
                                await API.updateCard(setId, id, null, null, true);
                                loadCards(setId);
                                loadDoneCards();
                            } catch (error) {
                                console.error('Failed to mark card as complete:', error);
                                alert('Failed to mark card as complete. Please try again.');
                            }
                        });
                    });
                    cardContainer.querySelectorAll('.edit-card-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = btn.getAttribute('data-id');
                            const cardDiv = btn.closest('.card-set');
                            cardDiv.querySelector('.card-content-view').style.display = 'none';
                            cardDiv.querySelector('.edit-card-form').style.display = 'block';
                        });
                    });
                    cardContainer.querySelectorAll('.cancel-edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const cardDiv = btn.closest('.card-set');
                            cardDiv.querySelector('.edit-card-form').style.display = 'none';
                            cardDiv.querySelector('.card-content-view').style.display = 'block';
                        });
                    });
                    cardContainer.querySelectorAll('.edit-card-form').forEach(form => {
                        form.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const id = form.getAttribute('data-id');
                            const question = form.elements['edit-question'].value.trim();
                            const answer = form.elements['edit-answer'].value.trim();
                            try {
                                await API.updateCard(setId, id, question, answer);
                                loadCards(setId);
                            } catch (error) {
                                console.error('Failed to update card:', error);
                                alert('Failed to update card. Please try again.');
                            }
                        });
                    });
                    cardContainer.querySelectorAll('.delete-card-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = btn.getAttribute('data-id');
                            const cardDiv = btn.closest('.card-set');
                            
                            // Get current card data from DOM
                            const question = cardDiv.querySelector('h3').textContent;
                            const answer = cardDiv.querySelector('p').textContent;
                            
                            // Create placeholder
                            const placeholder = document.createElement('div');
                            placeholder.className = 'card-set deleting';
                            placeholder.innerHTML = `
                                <div class="card-content-view">
                                    <h3>${question}</h3>
                                    <p>${answer}</p>
                                    <div class="deleting-status">Deleting...</div>
                                </div>
                            `;
                            
                            // Store the original card's position
                            const originalIndex = Array.from(cardContainer.children).indexOf(cardDiv);
                            
                            // Remove the original card
                            cardDiv.remove();
                            
                            // Insert placeholder at the exact same position
                            if (cardContainer.children.length === 0 || originalIndex >= cardContainer.children.length) {
                                cardContainer.appendChild(placeholder);
                            } else {
                                cardContainer.insertBefore(placeholder, cardContainer.children[originalIndex]);
                            }
                            
                            // Create a variable to store the timeout ID
                            let deleteTimeout;
                            
                            // Show undo bar
                            showInlineUndo(cardContainer, originalIndex, 'Card deleted.', () => {
                                // Undo: restore original card and clear the timeout
                                clearTimeout(deleteTimeout);
                                placeholder.remove();
                                if (cardContainer.children.length === 0 || originalIndex >= cardContainer.children.length) {
                                    cardContainer.appendChild(cardDiv);
                                } else {
                                    cardContainer.insertBefore(cardDiv, cardContainer.children[originalIndex]);
                                }
                            });
                            
                            // Set timeout for actual deletion
                            deleteTimeout = setTimeout(async () => {
                                try {
                                    await API.deleteCard(setId, id);
                                    placeholder.remove();
                                    loadCards(setId);
                                } catch (error) {
                                    console.error('Failed to delete card:', error);
                                    alert('Failed to delete card. Please try again.');
                                    // Restore original card on error
                                    placeholder.remove();
                                    if (cardContainer.children.length === 0 || originalIndex >= cardContainer.children.length) {
                                        cardContainer.appendChild(cardDiv);
                                    } else {
                                        cardContainer.insertBefore(cardDiv, cardContainer.children[originalIndex]);
                                    }
                                }
                            }, 5000);
                        });
                    });
                } catch (error) {
                    console.error('Failed to load cards:', error);
                    alert('Failed to load cards. Please try again.');
                }
            }
            // Initialize event listeners
            function initializeEventListeners() {
                // Removed left panel toggle event handler; left panel is always visible
                if (toggleCompletedPanel && colRight) {
                    toggleCompletedPanel.addEventListener('click', () => {
                        colRight.classList.toggle('panel-visible');
                        if (colRight.classList.contains('panel-visible')) {
                            loadDoneCards();
                        }
                        updateGrid();
                    });
                }
                // Show library button
                const showLibraryBtn = document.getElementById('show-card-sets');
                if (showLibraryBtn) {
                    showLibraryBtn.addEventListener('click', () => {
                        currentSetId = null;
                        document.getElementById('current-set-name').textContent = 'Library';
                        document.getElementById('current-set-description').textContent = '';
                        document.querySelector('.card-list-container').style.display = 'none';
                        document.getElementById('card-sets-list').style.display = 'flex';
                        document.getElementById('card-sets-list').classList.remove('stacked-layout');
                        document.getElementById('add-flashcard').style.display = 'none';
                        document.getElementById('new-set-btn').style.display = 'inline-block';
                        document.getElementById('header-completed-btn').style.display = 'none';
                        document.getElementById('header-card-count').style.display = 'none';
                        showLibraryBtn.classList.add('active');
                        document.getElementById('show-home').classList.remove('active');
                        loadLibrary();
                    });
                }
                // Show home button
                const showHomeBtn = document.getElementById('show-home');
                if (showHomeBtn) {
                    showHomeBtn.addEventListener('click', () => {
                        currentSetId = null;
                        document.getElementById('current-set-name').textContent = 'Home';
                        document.getElementById('current-set-description').textContent = '';
                        document.querySelector('.card-list-container').style.display = 'none';
                        document.getElementById('card-sets-list').style.display = 'flex';
                        document.getElementById('card-sets-list').classList.add('stacked-layout');
                        document.getElementById('add-flashcard').style.display = 'none';
                        document.getElementById('new-set-btn').style.display = 'inline-block';
                        document.getElementById('header-completed-btn').style.display = 'none';
                        document.getElementById('header-card-count').style.display = 'none';
                        showHomeBtn.classList.add('active');
                        document.getElementById('show-card-sets').classList.remove('active');
                        loadLibrary();
                    });
                }
                // Show themes button
                const showThemesBtn = document.getElementById('show-themes');
                if (showThemesBtn) {
                    showThemesBtn.addEventListener('click', () => {
                        document.getElementById('current-set-name').textContent = 'Themes';
                        document.getElementById('current-set-description').textContent = '';
                        document.querySelector('.card-list-container').style.display = 'none';
                        document.getElementById('card-sets-list').style.display = 'none';
                        document.getElementById('add-flashcard').style.display = 'none';
                        document.getElementById('new-set-btn').style.display = 'none';
                        document.getElementById('continue-with-btn').style.display = 'none';
                        document.getElementById('header-completed-btn').style.display = 'none';
                        document.getElementById('header-card-count').style.display = 'none';
                        showThemesBtn.classList.add('active');
                        document.getElementById('show-home').classList.remove('active');
                        document.getElementById('show-card-sets').classList.remove('active');
                        document.getElementById('show-import').classList.remove('active');
                    });
                }
                // Show import button
                const showImportBtn = document.getElementById('show-import');
                if (showImportBtn) {
                    showImportBtn.addEventListener('click', () => {
                        document.getElementById('current-set-name').textContent = 'Import';
                        document.getElementById('current-set-description').textContent = '';
                        document.querySelector('.card-list-container').style.display = 'none';
                        document.getElementById('card-sets-list').style.display = 'none';
                        document.getElementById('add-flashcard').style.display = 'none';
                        document.getElementById('new-set-btn').style.display = 'none';
                        document.getElementById('continue-with-btn').style.display = 'none';
                        document.getElementById('header-completed-btn').style.display = 'none';
                        document.getElementById('header-card-count').style.display = 'none';
                        showImportBtn.classList.add('active');
                        document.getElementById('show-home').classList.remove('active');
                        document.getElementById('show-card-sets').classList.remove('active');
                        document.getElementById('show-themes').classList.remove('active');
                    });
                }
                // Add new set button
                const newSetBtn = document.getElementById('new-set-btn');
                const newSetForm = document.getElementById('new-set-form');
                const cancelNewSet = document.getElementById('cancel-new-set');
                if (newSetBtn) {
                    newSetBtn.addEventListener('click', () => {
                        newSetForm.classList.remove('hidden');
                        newSetBtn.style.display = 'none';
                    });
                }
                if (cancelNewSet) {
                    cancelNewSet.addEventListener('click', () => {
                        newSetForm.reset();
                        newSetForm.classList.add('hidden');
                        newSetBtn.style.display = 'inline-block';
                    });
                }
                if (newSetForm) {
                    newSetForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = document.getElementById('new-set-name').value.trim();
                        const desc = document.getElementById('new-set-desc').value.trim();
                        if (!name) return;
                        try {
                            await API.createSet(name, desc);
                            newSetForm.reset();
                            newSetForm.classList.add('hidden');
                            newSetBtn.style.display = 'inline-block';
                            loadLibrary();
                        } catch (error) {
                            console.error('Failed to create set:', error);
                            alert('Failed to create set. Please try again.');
                        }
                    });
                }
                // Add flashcard button
                const addFlashcardBtn = document.getElementById('add-flashcard');
                const addFlashcardForm = document.getElementById('add-flashcard-form');
                const cancelAddFlashcard = document.getElementById('cancel-add-flashcard');
                if (addFlashcardBtn) {
                    addFlashcardBtn.addEventListener('click', () => {
                        if (!currentSetId) {
                            alert('Please select a library first!');
                            return;
                        }
                        addFlashcardForm.classList.remove('hidden');
                        addFlashcardBtn.style.display = 'none';
                    });
                }
                if (cancelAddFlashcard) {
                    cancelAddFlashcard.addEventListener('click', () => {
                        addFlashcardForm.reset();
                        addFlashcardForm.classList.add('hidden');
                        addFlashcardBtn.style.display = 'inline-block';
                    });
                }
                if (addFlashcardForm) {
                    addFlashcardForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const question = document.getElementById('flashcard-question').value.trim();
                        const answer = document.getElementById('flashcard-answer').value.trim();
                        if (!question || !answer) return;
                        try {
                            await API.createCard(currentSetId, question, answer);
                            addFlashcardForm.reset();
                            addFlashcardForm.classList.add('hidden');
                            addFlashcardBtn.style.display = 'inline-block';
                            loadCards(currentSetId);
                        } catch (error) {
                            console.error('Failed to create card:', error);
                            alert('Failed to create card. Please try again.');
                        }
                    });
                }
                // Ensure hamburger toggles and calls updateGrid
                const navCollapseBtn = document.getElementById('nav-collapse-btn');
                if (navCollapseBtn) {
                    navCollapseBtn.addEventListener('click', () => {
                        layout3col.classList.toggle('left-collapsed');
                        updateGrid();
                    });
                }
            }
            // Initialize the app
            initializeEventListeners();
            // Set initial view state
            document.querySelector('.card-list-container').style.display = 'none';
            document.getElementById('card-sets-list').style.display = 'flex';
            document.getElementById('add-flashcard').style.display = 'none';
            document.getElementById('new-set-btn').style.display = 'inline-block';
            document.getElementById('header-completed-btn').style.display = 'none';
            document.getElementById('current-set-name').textContent = 'Home';
            // Set Home button as active
            document.getElementById('show-home').classList.add('active');
            // Open sidebar by default
            colLeft.classList.add('panel-visible');
            updateGrid();
            // Load initial content
            loadLibrary();
            // Load the current set
            if (currentSetId) {
                loadCards(currentSetId);
                loadLibrary(); // Ensure .active is applied
            }
            // Make toggleCardCompletion available globally
            window.toggleCardCompletion = async function(cardId) {
                try {
                    const card = await API.getCard(currentSetId, cardId);
                    await API.updateCard(currentSetId, cardId, null, null, !card.completed);
                    loadCards(currentSetId);
                    loadDoneCards();
                } catch (error) {
                    console.error('Failed to toggle card completion:', error);
                    alert('Failed to toggle card completion. Please try again.');
                }
            };
            // Add view switching function
            function switchToCardView(setId) {
                document.getElementById('card-sets-list').style.display = 'none';
                document.querySelector('.card-list-container').style.display = 'flex';
                document.getElementById('add-flashcard').style.display = 'inline-block';
                document.getElementById('new-set-btn').style.display = 'none';
                document.getElementById('continue-with-btn').style.display = 'none';
                document.getElementById('header-completed-btn').style.display = 'inline-block';
                document.getElementById('header-card-count').style.display = 'inline-block';
                
                // Set up the completed panel button
                const headerCompletedBtn = document.getElementById('header-completed-btn');
                if (headerCompletedBtn && colRight) {
                    headerCompletedBtn.onclick = () => {
                        colRight.classList.toggle('panel-visible');
                        if (colRight.classList.contains('panel-visible')) {
                            loadDoneCards();
                        }
                        updateGrid();
                    };
                }
                
                loadCards(setId);
            }

            function switchToLibraryView() {
                document.getElementById('card-sets-list').style.display = 'flex';
                document.querySelector('.card-list-container').style.display = 'none';
                document.getElementById('add-flashcard').style.display = 'none';
                document.getElementById('new-set-btn').style.display = 'inline-block';
                document.getElementById('header-completed-btn').style.display = 'none';
                document.getElementById('header-card-count').style.display = 'none';
                document.getElementById('current-set-name').textContent = 'Library';
                document.getElementById('current-set-description').textContent = '';
            }
        });
    </script>
  </body>
</html>
